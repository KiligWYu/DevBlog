<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Kilig çš„åšå®¢ | ä»£ç ä¹‹å¤–"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>Concurrency å¤‡å¿˜æ¸…å• | ğ•¶ğ–ğ–‘ğ–ğ–Œ'ğ–˜ ğ•­ğ–‘ğ–”ğ–Œ</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-YLMXL0J5N0" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-YLMXL0J5N0');
</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 7.1.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Concurrency å¤‡å¿˜æ¸…å•</h1><a id="logo" href="/.">ğ•¶ğ–ğ–‘ğ–ğ–Œ'ğ–˜ ğ•­ğ–‘ğ–”ğ–Œ</a><p class="description">ä»£ç ä¹‹å¤–</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/categories/%E7%A2%8E%E5%91%A8%E6%8A%A5/"><i class="fa fa-envelope"> ç¢å‘¨æŠ¥</i></a><a href="/categories/Learn-in-Public/"><i class="fa fa-leanpub"> Learn in Public</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">Concurrency å¤‡å¿˜æ¸…å•</h1><div class="post-meta">2024-07-06</div><!-- if theme.disqus.enable == true// a.disqus-comment-count(data-disqus-identifier=page.path, href=url_for(page.path) + '#disqus_thread')--><div class="post-content"><ul>
<li><a href="#%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0">å¼‚æ­¥å‡½æ•°</a>
<ul>
<li><a href="#%E5%BC%82%E6%AD%A5%E6%8A%9B%E5%87%BA%E5%87%BD%E6%95%B0">å¼‚æ­¥æŠ›å‡ºå‡½æ•°</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0">ç¬¬ä¸€ä¸ªå¼‚æ­¥å‡½æ•°</a></li>
<li><a href="#%E8%B0%83%E7%94%A8%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0%E7%9A%84%E6%80%A7%E8%83%BD%E6%88%90%E6%9C%AC">è°ƒç”¨å¼‚æ­¥å‡½æ•°çš„æ€§èƒ½æˆæœ¬</a></li>
</ul>
</li>
<li><a href="#%E5%BC%82%E6%AD%A5%E5%B1%9E%E6%80%A7">å¼‚æ­¥å±æ€§</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-async-let-%E8%B0%83%E7%94%A8%E5%BC%82%E6%AD%A5%E5%87%BD%E6%95%B0">ä½¿ç”¨ async let è°ƒç”¨å¼‚æ­¥å‡½æ•°</a>
<ul>
<li><a href="#wait-%E5%92%8C-async-let-%E7%9A%84%E5%8C%BA%E5%88%AB">wait å’Œ async let çš„åŒºåˆ«</a></li>
<li><a href="#async-var">async varï¼Ÿ</a></li>
</ul>
</li>
<li><a href="#continuations">Continuations</a>
<ul>
<li><a href="#%E5%8F%AF%E4%BB%A5%E6%8A%9B%E5%87%BA%E9%94%99%E7%9A%84-continuations">å¯ä»¥æŠ›å‡ºé”™çš„ Continuations</a></li>
<li><a href="#%E5%AD%98%E5%82%A8-continuations">å­˜å‚¨ Continuations</a></li>
</ul>
</li>
<li><a href="#%E5%9C%A8%E4%B8%8D%E6%94%AF%E6%8C%81%E5%B9%B6%E5%8F%91%E7%9A%84%E5%87%BD%E6%95%B0%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8">åœ¨ä¸æ”¯æŒå¹¶å‘çš„å‡½æ•°ä¸­è¿›è¡Œå¼‚æ­¥è°ƒç”¨</a></li>
<li><a href="#sequence-asyncsequence-%E5%92%8C-asyncstream">Sequenceã€AsyncSequence å’Œ AsyncStream</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-for-wait-%E5%BE%AA%E7%8E%AF-asyncsequence">ä½¿ç”¨ for wait å¾ªç¯ AsyncSequence</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-map-filter-%E7%AD%89%E6%93%8D%E4%BD%9C-asyncsequence">ä½¿ç”¨ map ()ã€filter () ç­‰æ“ä½œ AsyncSequence</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E6%AD%A5%E5%BA%8F%E5%88%97">åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥åºåˆ—</a></li>
<li><a href="#%E5%B0%86-asyncsequence-%E8%BD%AC%E6%8D%A2%E4%B8%BA-sequence">å°† AsyncSequence è½¬æ¢ä¸º Sequence</a></li>
</ul>
</li>
<li><a href="#task">Task</a>
<ul>
<li><a href="#task-%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C">Task çš„åˆ›å»ºå’Œè¿è¡Œ</a></li>
<li><a href="#detached-task">Detached Task</a></li>
<li><a href="#%E4%BB%8E%E4%BB%BB%E5%8A%A1%E4%B8%AD%E8%8E%B7%E5%8F%96%E7%BB%93%E6%9E%9C">ä»ä»»åŠ¡ä¸­è·å–ç»“æœ</a></li>
<li><a href="#%E4%BB%BB%E5%8A%A1%E4%BC%98%E5%85%88%E7%BA%A7">ä»»åŠ¡ä¼˜å…ˆçº§</a></li>
<li><a href="#%E4%BC%98%E5%85%88%E7%BA%A7%E5%8D%87%E7%BA%A7">ä¼˜å…ˆçº§å‡çº§</a></li>
<li><a href="#%E5%8F%96%E6%B6%88%E4%BB%BB%E5%8A%A1">å–æ¶ˆä»»åŠ¡</a></li>
<li><a href="#%E4%BC%91%E7%9C%A0%E4%BB%BB%E5%8A%A1">ä¼‘çœ ä»»åŠ¡</a></li>
<li><a href="#%E4%B8%BB%E5%8A%A8%E6%9A%82%E5%81%9C%E4%BB%BB%E5%8A%A1">ä¸»åŠ¨æš‚åœä»»åŠ¡</a></li>
</ul>
</li>
<li><a href="#task-group">Task Group</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%E7%BB%84%E5%B9%B6%E5%90%91%E5%85%B6%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%BB%E5%8A%A1">åˆ›å»ºä»»åŠ¡ç»„å¹¶å‘å…¶ä¸­æ·»åŠ ä»»åŠ¡</a></li>
<li><a href="#%E5%8F%96%E6%B6%88%E4%BB%BB%E5%8A%A1%E7%BB%84">å–æ¶ˆä»»åŠ¡ç»„</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1%E7%BB%84%E4%B8%AD%E7%9A%84%E4%B8%8D%E5%90%8C%E7%BB%93%E6%9E%9C%E7%B1%BB%E5%9E%8B">å¦‚ä½•å¤„ç†ä»»åŠ¡ç»„ä¸­çš„ä¸åŒç»“æœç±»å‹</a></li>
</ul>
</li>
<li><a href="#swiftui-%E4%B8%AD%E7%9A%84-task-%E4%BF%AE%E9%A5%B0%E7%AC%A6">SwiftUI ä¸­çš„ task() ä¿®é¥°ç¬¦</a></li>
<li><a href="#actors">Actors</a>
<ul>
<li><a href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E9%9A%94%E7%A6%BB">å‡½æ•°å‚æ•°éš”ç¦»</a></li>
<li><a href="#%E9%83%A8%E5%88%86%E9%9A%94%E7%A6%BB">éƒ¨åˆ†éš”ç¦»</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-mainactor-%E5%9C%A8%E4%B8%BB%E9%98%9F%E5%88%97%E4%B8%8A%E8%BF%90%E8%A1%8C%E4%BB%A3%E7%A0%81">ä½¿ç”¨ @MainActor åœ¨ä¸»é˜Ÿåˆ—ä¸Šè¿è¡Œä»£ç </a></li>
<li><a href="#%E5%85%A8%E5%B1%80-actor-%E6%8E%A8%E6%96%AD%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">å…¨å±€ actor æ¨æ–­çš„å·¥ä½œåŸç†</a></li>
<li><a href="#actor-%E8%B7%B3%E8%B7%83">actor è·³è·ƒ</a></li>
<li><a href="#actors-classes-and-structs-%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB">actors, classes, and structs ä¹‹é—´çš„åŒºåˆ«</a></li>
</ul>
</li>
<li><a href="#%E5%8F%A6%E8%A7%81">å¦è§</a></li>
</ul>
<p>æœ¬ç¯‡æ˜¯ <a target="_blank" rel="noopener" href="https://www.hackingwithswift.com/quick-start/concurrency">Swift Concurrency by Example</a> çš„å­¦ä¹ ç¬”è®°ã€‚ç®€è¦è®°å½•ï¼Œå¤‡å¿˜æ¸…å•ã€‚æ¨èçœ‹åŸæ•™ç¨‹ï¼Œé…åˆä»£ç ç¤ºä¾‹æ›´ä½³æ¸…æ™°æ˜“æ‡‚ã€‚</p>
<hr />
<blockquote>
<p>Concurrency is about dealing with many things at once, parallelism is about doing many things at once. Concurrency is a way to structure things so you can maybe use parallelism to do a better job. â€”â€” Rob Pike</p>
</blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ Swift å‡½æ•°éƒ½æ˜¯åŒæ­¥çš„ã€‚åŒæ­¥å‡½æ•°ä¼šå¯¼è‡´é˜»å¡ï¼Œä»è€Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚å¼‚æ­¥å‡½æ•°ä¸ä¼šé˜»å¡ã€‚</p>
<h2 id="å¼‚æ­¥å‡½æ•°"><a class="markdownIt-Anchor" href="#å¼‚æ­¥å‡½æ•°"></a> å¼‚æ­¥å‡½æ•°</h2>
<p>é€šè¿‡å…³é”®å­— <code>async</code> æ¥åˆ›å»ºå¼‚æ­¥å‡½æ•°ï¼Œåœ¨å¼‚æ­¥å‡½æ•°å†…éƒ¨ï¼Œå¯ä»¥ä½¿ç”¨ <code>await</code> å…³é”®å­—æ¥è°ƒç”¨å…¶ä»–å¼‚æ­¥å‡½æ•°ã€‚</p>
<ul>
<li><code>async</code> æ˜¯å‡½æ•°ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>ç”¨ <code>async</code> æ ‡è®°å‡½æ•°æ„å‘³ç€å®ƒå¯èƒ½ä¼šæ‰§è¡Œå¼‚æ­¥å·¥ä½œï¼Œè€Œä¸æ˜¯å¿…é¡»æ‰§è¡Œå¼‚æ­¥å·¥ä½œã€‚åŒæ ·ï¼Œ <code>throws</code> ä¹Ÿæ˜¯å¦‚æ­¤ - é€šè¿‡å‡½æ•°çš„æŸäº›è·¯å¾„å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†å…¶ä»–è·¯å¾„å¯èƒ½ä¸ä¼šã€‚</li>
</ul>
<p>å½“ä½¿ç”¨ <code>await</code> è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬æ ‡è®°äº†ä¸€ä¸ªæŒ‚èµ·ç‚¹ï¼Œè¿™æ˜¯å‡½æ•°å¯ä»¥æŒ‚èµ·è‡ªèº«çš„åœ°æ–¹ï¼ˆå®é™…ä¸Šæ˜¯åœæ­¢è¿è¡Œï¼‰ï¼Œä»¥ä¾¿å¯ä»¥è¿›è¡Œå…¶ä»–å·¥ä½œã€‚åœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œè¯¥å‡½æ•°çš„å·¥ä½œå®Œæˆï¼ŒSwift ä¼šå°†å…¶ä» â€œå‡æ­»â€ èˆ¬çš„çŠ¶æ€ä¸­å”¤é†’ï¼Œå¹¶ç»§ç»­å·¥ä½œã€‚</p>
<ul>
<li>å½“ä¸€ä¸ªå¼‚æ­¥å‡½æ•°è¢«æŒ‚èµ·æ—¶ï¼Œæ‰€æœ‰è°ƒç”¨å®ƒçš„å¼‚æ­¥å‡½æ•°ä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚å¼‚æ­¥å‡½æ•°å…·æœ‰å¸¸è§„åŒæ­¥å‡½æ•°æ‰€æ²¡æœ‰çš„ç‰¹æ®Šæš‚åœèƒ½åŠ›ã€‚æ­£æ˜¯ç”±äºè¿™ä¸ªåŸå› ï¼ŒåŒæ­¥å‡½æ•°æ— æ³•ç›´æ¥è°ƒç”¨å¼‚æ­¥å‡½æ•°ã€‚</li>
<li>ä¸€ä¸ªå‡½æ•°å¯ä»¥æ ¹æ®éœ€è¦å¤šæ¬¡æŒ‚èµ·ï¼Œä½¿ç”¨ <code>await</code> å…³é”®å­—ã€‚</li>
<li>è¢«æŒ‚èµ·çš„å‡½æ•°ä¸ä¼šé˜»å¡å®ƒæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œè€Œæ˜¯æ”¾å¼ƒè¯¥çº¿ç¨‹ï¼Œä»¥ä¾¿ Swift å¯ä»¥åšå…¶ä»–å·¥ä½œã€‚</li>
<li>å½“å‡½æ•°æ¢å¤æ—¶ï¼Œå®ƒå¯èƒ½ä¸ä»¥å‰ä¸€æ ·åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œä½†ä¹Ÿå¯èƒ½ä¸æ˜¯ã€‚</li>
</ul>
<h3 id="å¼‚æ­¥æŠ›å‡ºå‡½æ•°"><a class="markdownIt-Anchor" href="#å¼‚æ­¥æŠ›å‡ºå‡½æ•°"></a> å¼‚æ­¥æŠ›å‡ºå‡½æ•°</h3>
<p>æŠŠå‡½æ•°æ ‡è®°ä¸º <code>async throws</code> ï¼Œä½¿ç”¨ <code>try await</code> è°ƒç”¨è¯¥å‡½æ•°ã€‚æ³¨æ„å…³é”®å­—çš„é¡ºåºï¼Œåœ¨å‡½æ•°å®šä¹‰ä¸­æ˜¯ â€œå¼‚æ­¥ï¼ŒæŠ›å‡ºâ€ï¼Œä½†åœ¨è°ƒç”¨ç«™ç‚¹æ˜¯ â€œæŠ›å‡ºï¼Œå¼‚æ­¥â€ã€‚<code>try await</code> ä¸ä»…æ¯” <code>await try</code> æ›´å®¹æ˜“é˜…è¯»ï¼Œè€Œä¸”å®ƒä¹Ÿæ›´èƒ½åæ˜ ä»£ç æ‰§è¡Œæ—¶å®é™…å‘ç”Ÿçš„æƒ…å†µï¼šæˆ‘ä»¬æ­£åœ¨ç­‰å¾…æŸäº›å·¥ä½œå®Œæˆï¼Œä»¥åŠå®ƒä½•æ—¶å®Œæˆå®Œæˆåæˆ‘ä»¬å°†æ£€æŸ¥å®ƒæ˜¯å¦æœ€ç»ˆæŠ›å‡ºé”™è¯¯ã€‚</p>
<blockquote>
<p>This order restriction is arbitrary, but itâ€™s not harmful, and it eliminates the potential for stylistic debates.</p>
</blockquote>
<h3 id="ç¬¬ä¸€ä¸ªå¼‚æ­¥å‡½æ•°"><a class="markdownIt-Anchor" href="#ç¬¬ä¸€ä¸ªå¼‚æ­¥å‡½æ•°"></a> ç¬¬ä¸€ä¸ªå¼‚æ­¥å‡½æ•°</h3>
<p>å¦‚æœåªæœ‰å¼‚æ­¥å‡½æ•°å¯ä»¥è°ƒç”¨å…¶ä»–å¼‚æ­¥å‡½æ•°ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆè°ƒç”¨äº†ç¬¬ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Ÿ</p>
<p>æœ‰ä¸‰ç§ä¸»è¦æ–¹å¼ï¼š</p>
<ol>
<li>åœ¨ä½¿ç”¨ <code>@main</code> å±æ€§çš„ç®€å•å‘½ä»¤è¡Œç¨‹åºä¸­ï¼Œä½ å¯ä»¥å°† <code>main()</code> æ–¹æ³•å£°æ˜ä¸ºå¼‚æ­¥æ–¹æ³•ã€‚è¿™æ„å‘³ç€æ‚¨çš„ç¨‹åºå°†ç«‹å³å¯åŠ¨åˆ°å¼‚æ­¥å‡½æ•°ï¼Œå› æ­¤ä½ å¯ä»¥è‡ªç”±è°ƒç”¨å…¶ä»–å¼‚æ­¥å‡½æ•°ã€‚</li>
<li>åœ¨ä½¿ç”¨ SwiftUI ç­‰æ„å»ºçš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ¡†æ¶æœ¬èº«æœ‰å¤šä¸ªå¯ä»¥è§¦å‘å¼‚æ­¥å‡½æ•°çš„åœ°æ–¹ã€‚ä¾‹å¦‚ï¼Œ <code>refreshable()</code> å’Œ <code>task()</code> ä¿®é¥°ç¬¦éƒ½å¯ä»¥è‡ªç”±è°ƒç”¨å¼‚æ­¥å‡½æ•°ã€‚</li>
<li>Swift æä¾›äº†ä¸“ç”¨çš„ <code>Task</code> APIã€‚</li>
</ol>
<h3 id="è°ƒç”¨å¼‚æ­¥å‡½æ•°çš„æ€§èƒ½æˆæœ¬"><a class="markdownIt-Anchor" href="#è°ƒç”¨å¼‚æ­¥å‡½æ•°çš„æ€§èƒ½æˆæœ¬"></a> è°ƒç”¨å¼‚æ­¥å‡½æ•°çš„æ€§èƒ½æˆæœ¬</h3>
<p>åŒæ­¥å’Œå¼‚æ­¥å‡½æ•°åœ¨å†…éƒ¨ä½¿ç”¨ä¸åŒçš„è°ƒç”¨çº¦å®šï¼Œå¼‚æ­¥å˜ä½“çš„æ•ˆç‡ç¨ä½ã€‚</p>
<p>æ¯å½“æˆ‘ä»¬ä½¿ç”¨ <code>await</code> è°ƒç”¨å¼‚æ­¥å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨ä»£ç ä¸­æ ‡è®°ä¸€ä¸ªæ½œåœ¨çš„æŒ‚èµ·ç‚¹ï¼ŒSwift æ— æ³•åœ¨ç¼–è¯‘æ—¶åˆ¤æ–­ <code>await</code> è°ƒç”¨æ˜¯å¦ä¼šæŒ‚èµ·ï¼Œè¿è¡Œæ—¶å‘ç”Ÿçš„æƒ…å†µå–å†³äºè°ƒç”¨æ˜¯å¦æŒ‚èµ·ï¼š</p>
<ul>
<li>å¦‚æœå‘ç”Ÿæš‚åœï¼Œé‚£ä¹ˆ Swift å°†æš‚åœè¯¥å‡½æ•°åŠå…¶æ‰€æœ‰è°ƒç”¨è€…ï¼Œè¿™ä¼šäº§ç”Ÿå¾ˆå°çš„æ€§èƒ½æˆæœ¬ã€‚</li>
<li>å¦‚æœæ²¡æœ‰å‘ç”Ÿæš‚åœï¼Œåˆ™ä¸ä¼šå‘ç”Ÿæš‚åœï¼Œå¹¶ä¸”æ‚¨çš„å‡½æ•°å°†ç»§ç»­ä»¥ä¸åŒæ­¥å‡½æ•°ç›¸åŒçš„æ•ˆç‡å’Œæ—¶åºè¿è¡Œã€‚</li>
</ul>
<p>å¼‚æ­¥å‡½æ•°è¿˜æœ‰ä¸€ä¸ªå‰¯ä½œç”¨ï¼šä½¿ç”¨ <code>await</code> ä¸ä¼šå¯¼è‡´æ‚¨çš„ä»£ç åœ¨ç»§ç»­ä¹‹å‰ç­‰å¾…ä¸€ä¸ªè¿è¡Œå¾ªç¯ã€‚ç›¸è¾ƒäº <code>DispatchQueue.main.async &#123; â€¦ &#125;</code> ä½¿ç”¨ <code>await</code> ï¼Œä»£ç å°†ç«‹å³æ‰§è¡Œã€‚</p>
<h2 id="å¼‚æ­¥å±æ€§"><a class="markdownIt-Anchor" href="#å¼‚æ­¥å±æ€§"></a> å¼‚æ­¥å±æ€§</h2>
<p>Swift ä¸­ï¼Œåªè¯»è®¡ç®—å±æ€§ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> contents: <span class="type">T</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="keyword">async</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// more code to come</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨-async-let-è°ƒç”¨å¼‚æ­¥å‡½æ•°"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-async-let-è°ƒç”¨å¼‚æ­¥å‡½æ•°"></a> ä½¿ç”¨ async let è°ƒç”¨å¼‚æ­¥å‡½æ•°</h2>
<p>æœ‰æ—¶æ‚¨æƒ³åŒæ—¶è¿è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œç„¶åç­‰å¾…å®ƒä»¬çš„ç»“æœè¿”å›ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>async let</code> ã€‚æ¯”å¦‚åŒæ—¶å‘èµ·ä¸¤ä¸ªç½‘ç»œè¯·æ±‚ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">loadData</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">let</span> (userData, <span class="keyword">_</span>) <span class="operator">=</span> <span class="type">URLSession</span>.shared.data(from: <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/user-24601.json&quot;</span>)<span class="operator">!</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">let</span> (messageData, <span class="keyword">_</span>) <span class="operator">=</span> <span class="type">URLSession</span>.shared.data(from: <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/user-messages.json&quot;</span>)<span class="operator">!</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// more code to come</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹ä¸Šé¢çš„ä»£ç ï¼š</p>
<ul>
<li>å³ä½¿ <code>data(from:)</code> æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦åœ¨å®ƒä¹‹å‰ä½¿ç”¨ <code>await</code> å› ä¸ºè¿™æ˜¯ç”± <code>async let</code> æš—ç¤ºçš„ã€‚</li>
<li><code>data(from:)</code> æ–¹æ³•ä¹Ÿä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä½†æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨ <code>try</code> æ¥æ‰§è¡Œå®ƒï¼Œå› ä¸ºå®ƒä¼šè¢«æ¨è¿Ÿåˆ°æˆ‘ä»¬çœŸæ­£æƒ³è¦è¯»å–å…¶è¿”å›å€¼çš„æ—¶å€™ã€‚Swift ç¼–è¯‘å™¨å°†è‡ªåŠ¨è·Ÿè¸ªå“ªäº› <code>async let</code> å¸¸é‡å¯èƒ½å¼•å‘é”™è¯¯ï¼Œå¹¶åœ¨è¯»å–å…¶å€¼æ—¶å¼ºåˆ¶ä½¿ç”¨ <code>try</code> ã€‚</li>
<li>è¿™ä¸¤ä¸ªç½‘ç»œè°ƒç”¨éƒ½ä¼šç«‹å³å¼€å§‹ï¼Œä½†å¯èƒ½ä»¥ä»»ä½•é¡ºåºå®Œæˆã€‚</li>
</ul>
<h3 id="wait-å’Œ-async-let-çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#wait-å’Œ-async-let-çš„åŒºåˆ«"></a> wait å’Œ async let çš„åŒºåˆ«</h3>
<p><code>await</code> ä¼šç­‰å¾…å·¥ä½œå®Œæˆï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è¯»å–å…¶ç»“æœï¼Œè€Œ <code>async let</code> åˆ™ä¸ä¼šã€‚</p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³è¦å‘å‡ºä¸¤ä¸ªç½‘ç»œè¯·æ±‚ï¼Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚ä¸å¦ä¸€ä¸ªè¯·æ±‚ç›¸å…³ï¼Œé‚£ä¹ˆåº”å½“ä½¿ç”¨ <code>await</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> first <span class="operator">=</span> <span class="keyword">await</span> requestFirstData()</span><br><span class="line"><span class="keyword">let</span> second <span class="operator">=</span> <span class="keyword">await</span> requestSecondData(using: first)</span><br></pre></td></tr></table></figure>
<p>è€Œå¦‚æœä¸¤ä¸ªç½‘ç»œè¯·æ±‚æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>async let</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">getAppData</span>() <span class="keyword">async</span> -&gt; ([<span class="type">News</span>], [<span class="type">Weather</span>], <span class="type">Bool</span>) &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">let</span> news <span class="operator">=</span> getNews()</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">let</span> weather <span class="operator">=</span> getWeather()</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">let</span> hasUpdate <span class="operator">=</span> getAppUpdateAvailable()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> (news, weather, hasUpdate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="async-var"><a class="markdownIt-Anchor" href="#async-var"></a> async varï¼Ÿ</h3>
<p>Swift çš„ <code>async let</code> è¯­æ³•æä¾›äº†ç®€çŸ­ã€æœ‰ç”¨çš„è¯­æ³•ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œå¤§é‡å·¥ä½œï¼Œè®©æˆ‘ä»¬å¯ä»¥ç¨åç­‰å¾…å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œå®ƒåªèƒ½ç”¨ä½œ <code>async let</code> - ä¸å¯èƒ½ä½¿ç”¨ <code>async var</code>ã€‚</p>
<p>å¦‚æœä½¿ç”¨ <code>async var</code> å¼‚æ­¥åˆ›å»ºä¸€ä¸ªå˜é‡ï¼Œç„¶åä¿®æ”¹å˜é‡çš„å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å–æ¶ˆäº†å¼‚æ­¥å·¥ä½œå—ï¼Ÿå¦‚æœä¸æ˜¯ï¼Œå½“å¼‚æ­¥å·¥ä½œå®Œæˆæ—¶ï¼Œå®ƒä¼šè¦†ç›–æˆ‘ä»¬çš„æ–°å€¼å—ï¼Ÿå³ä½¿æˆ‘ä»¬æ˜ç¡®è®¾ç½®äº†å€¼ï¼Œåœ¨è¯»å–å€¼æ—¶æ˜¯å¦ä»ç„¶éœ€è¦ä½¿ç”¨ await ï¼Ÿæ‰€ä»¥åªèƒ½ä½¿ç”¨ <code>async let</code>ã€‚</p>
<h2 id="continuations"><a class="markdownIt-Anchor" href="#continuations"></a> Continuations</h2>
<p>ä½¿ç”¨ Continuationsï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å¸¦æœ‰å®Œæˆå¤„ç†ç¨‹åºçš„æ—§å‡½æ•°å’Œæ–°å¼‚æ­¥ä»£ç ä¹‹é—´åˆ›å»ºä¸€åº§æ¡¥æ¢ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/swift/checkedcontinuation"><code>CheckedContinuation</code></a>: A mechanism to interface between synchronous and asynchronous code, logging correctness violations.</li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/swift/unsafecontinuation"><code>UnsafeContinuation</code></a>: A mechanism to interface between synchronous and asynchronous code, without correctness checking.</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Message</span>: <span class="title class_">Decodable</span>, <span class="title class_">Identifiable</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">let</span> from: <span class="type">String</span></span><br><span class="line">  <span class="keyword">let</span> message: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchMessages</span>(<span class="params">completion</span>: <span class="keyword">@escaping</span> ([<span class="type">Message</span>]) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/user-messages.json&quot;</span>)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">  <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; data, <span class="keyword">_</span>, <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> data <span class="operator">=</span> data &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> messages <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">JSONDecoder</span>().decode([<span class="type">Message</span>].<span class="keyword">self</span>, from: data) &#123;</span><br><span class="line">        completion(messages)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    completion([])</span><br><span class="line">  &#125;.resume()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchMessages</span>() <span class="keyword">async</span> -&gt; [<span class="type">Message</span>] &#123;</span><br><span class="line">  <span class="keyword">await</span> withCheckedContinuation &#123; continuation <span class="keyword">in</span></span><br><span class="line">    fetchMessages &#123; messages <span class="keyword">in</span></span><br><span class="line">      continuation.resume(returning: messages)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messages <span class="operator">=</span> <span class="keyword">await</span> fetchMessages()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Downloaded <span class="subst">\(messages.count)</span> messages.&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œåœ¨ç¨‹åºçš„æ¯ä¸ªæ‰§è¡Œè·¯å¾„ä¸­ï¼Œå¿…é¡»å‡†ç¡®åœ°è°ƒç”¨ä¸€æ¬¡ resume æ–¹æ³•ã€‚ å¦åˆ™ä¼šé€ æˆ continuation æ³„éœ²ï¼Œ</p>
<p>å¦‚æœæ‚¨ä»”ç»†æ£€æŸ¥äº†ä»£ç å¹¶ä¸”ç¡®å®šå®ƒæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°† <code>withCheckedContinuation()</code> å‡½æ•°æ›¿æ¢ä¸ºå¯¹ <code>withUnsafeContinuation()</code> çš„è°ƒç”¨ï¼Œå…¶å·¥ä½œåŸç†å®Œå…¨ç›¸åŒæ–¹å¼ï¼Œä½†ä¸ä¼šå¢åŠ æ£€æŸ¥æ‚¨æ˜¯å¦æ­£ç¡®ä½¿ç”¨å»¶ç»­çš„è¿è¡Œæ—¶æˆæœ¬ã€‚</p>
<h3 id="å¯ä»¥æŠ›å‡ºé”™çš„-continuations"><a class="markdownIt-Anchor" href="#å¯ä»¥æŠ›å‡ºé”™çš„-continuations"></a> å¯ä»¥æŠ›å‡ºé”™çš„ Continuations</h3>
<p><code>withCheckedThrowingContinuation()</code> å’Œ <code>withUnsafeThrowingContinuation()</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Message</span>: <span class="title class_">Decodable</span>, <span class="title class_">Identifiable</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">let</span> from: <span class="type">String</span></span><br><span class="line">  <span class="keyword">let</span> message: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchMessages</span>(<span class="params">completion</span>: <span class="keyword">@escaping</span> ([<span class="type">Message</span>]) -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/user-messages.json&quot;</span>)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">  <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; data, <span class="keyword">_</span>, <span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> data <span class="operator">=</span> data &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> messages <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">JSONDecoder</span>().decode([<span class="type">Message</span>].<span class="keyword">self</span>, from: data) &#123;</span><br><span class="line">        completion(messages)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    completion([])</span><br><span class="line">  &#125;.resume()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// An example error we can throw</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">FetchError</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> noMessages</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchMessages</span>() <span class="keyword">async</span> -&gt; [<span class="type">Message</span>] &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> <span class="keyword">await</span> withCheckedThrowingContinuation &#123; continuation <span class="keyword">in</span></span><br><span class="line">      fetchMessages &#123; messages <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> messages.isEmpty &#123;</span><br><span class="line">          continuation.resume(throwing: <span class="type">FetchError</span>.noMessages)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          continuation.resume(returning: messages)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="type">Message</span>(id: <span class="number">1</span>, from: <span class="string">&quot;Tom&quot;</span>, message: <span class="string">&quot;Welcome to MySpace! I&#x27;m your new friend.&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messages <span class="operator">=</span> <span class="keyword">await</span> fetchMessages()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Downloaded <span class="subst">\(messages.count)</span> messages.&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="å­˜å‚¨-continuations"><a class="markdownIt-Anchor" href="#å­˜å‚¨-continuations"></a> å­˜å‚¨ Continuations</h3>
<p>é€šè¿‡å°† Continuations å­˜å‚¨ä¸ºå±æ€§ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å¤šä¸ªä¸åŒçš„åœ°æ–¹æ¢å¤å®ƒã€‚</p>
<p>ä¸‹é¢ä»¥ <code>LocationManager</code> ä¸ºä¾‹ï¼ŒæŠŠ <code>continuation</code> å­˜å‚¨åœ¨å±æ€§ä¸­ï¼Œä½ç½®æ›´æ–°æˆåŠŸæˆ–å¤±è´¥æ˜¯åœ¨ä¸¤ä¸ªä»£ç†æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­æ¢å¤ continuationã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LocationManager</span>: <span class="title class_">NSObject</span>, <span class="title class_">ObservableObject</span>, <span class="title class_">CLLocationManagerDelegate</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> locationContinuation: <span class="type">CheckedContinuation</span>&lt;<span class="type">CLLocationCoordinate2D</span>?, <span class="type">Error</span>&gt;?</span><br><span class="line">  <span class="keyword">let</span> manager <span class="operator">=</span> <span class="type">CLLocationManager</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">    manager.delegate <span class="operator">=</span> <span class="keyword">self</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">requestLocation</span>() <span class="keyword">async</span> <span class="keyword">throws</span> -&gt; <span class="type">CLLocationCoordinate2D</span>? &#123;</span><br><span class="line">    <span class="keyword">try</span> <span class="keyword">await</span> withCheckedThrowingContinuation &#123; continuation <span class="keyword">in</span></span><br><span class="line">      locationContinuation <span class="operator">=</span> continuation</span><br><span class="line">      manager.requestLocation()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">locationManager</span>(<span class="keyword">_</span> <span class="params">manager</span>: <span class="type">CLLocationManager</span>, <span class="params">didUpdateLocations</span> <span class="params">locations</span>: [<span class="type">CLLocation</span>]) &#123;</span><br><span class="line">    locationContinuation<span class="operator">?</span>.resume(returning: locations.first<span class="operator">?</span>.coordinate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">locationManager</span>(<span class="keyword">_</span> <span class="params">manager</span>: <span class="type">CLLocationManager</span>, <span class="params">didFailWithError</span> <span class="params">error</span>: <span class="type">Error</span>) &#123;</span><br><span class="line">    locationContinuation<span class="operator">?</span>.resume(throwing: error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ContentView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">  <span class="meta">@StateObject</span> <span class="keyword">private</span> <span class="keyword">var</span> locationManager <span class="operator">=</span> <span class="type">LocationManager</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">    <span class="type">LocationButton</span> &#123;</span><br><span class="line">      <span class="type">Task</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> location <span class="operator">=</span> <span class="keyword">try?</span> <span class="keyword">await</span> locationManager.requestLocation() &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;Location: <span class="subst">\(location)</span>&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;Location unknown.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .frame(height: <span class="number">44</span>)</span><br><span class="line">    .foregroundColor(.white)</span><br><span class="line">    .clipShape(<span class="type">Capsule</span>())</span><br><span class="line">    .padding()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åœ¨ä¸æ”¯æŒå¹¶å‘çš„å‡½æ•°ä¸­è¿›è¡Œå¼‚æ­¥è°ƒç”¨"><a class="markdownIt-Anchor" href="#åœ¨ä¸æ”¯æŒå¹¶å‘çš„å‡½æ•°ä¸­è¿›è¡Œå¼‚æ­¥è°ƒç”¨"></a> åœ¨ä¸æ”¯æŒå¹¶å‘çš„å‡½æ•°ä¸­è¿›è¡Œå¼‚æ­¥è°ƒç”¨</h2>
<p>é€šè¿‡ä½¿ç”¨ <code>Task</code> æ¥è§£å†³é—®é¢˜ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">doAsyncWork</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Doing async work&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">doRegularWork</span>() &#123;</span><br><span class="line">  <span class="type">Task</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> doAsyncWork()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">doRegularWork()</span><br></pre></td></tr></table></figure>
<h2 id="sequence-asyncsequence-å’Œ-asyncstream"><a class="markdownIt-Anchor" href="#sequence-asyncsequence-å’Œ-asyncstream"></a> Sequenceã€AsyncSequence å’Œ AsyncStream</h2>
<ul>
<li><code>Sequence</code> åè®®ï¼Œå®ƒä¸æ–­è¿”å›å€¼ï¼Œç›´åˆ°é€šè¿‡è¿”å› <code>nil</code> ç»ˆæ­¢åºåˆ—ã€‚</li>
<li><code>AsyncSequence</code> åè®®å‡ ä¹ä¸ <code>Sequence</code> ç›¸åŒï¼Œä½†åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯å¼‚æ­¥è¿”å›çš„ã€‚
<ul>
<li>ä»å¼‚æ­¥åºåˆ—è¯»å–å€¼å¿…é¡»ä½¿ç”¨ `await</li>
</ul>
</li>
<li>æ›´é«˜çº§çš„å¼‚æ­¥åºåˆ—ï¼ˆ<code>AsyncStream</code>ï¼‰ç”Ÿæˆå€¼çš„é€Ÿåº¦å¯èƒ½æ¯”æ‚¨è¯»å–å®ƒä»¬çš„é€Ÿåº¦å¿«ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä¸¢å¼ƒé¢å¤–çš„å€¼æˆ–ç¼“å­˜å®ƒä»¬ä»¥ä¾¿ç¨åè¯»å–ã€‚`</li>
</ul>
<h3 id="ä½¿ç”¨-for-wait-å¾ªç¯-asyncsequence"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-for-wait-å¾ªç¯-asyncsequence"></a> ä½¿ç”¨ for wait å¾ªç¯ AsyncSequence</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/foundation/url/3767315-lines">URL lines</a>: The URLâ€™s resource data, as an asynchronous sequence of lines of text.</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">fetchUsers</span>() <span class="keyword">async</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/users.csv&quot;</span>)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">try</span> <span class="keyword">await</span> line <span class="keyword">in</span> url.lines &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Received user: <span class="subst">\(line)</span>&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try?</span> <span class="keyword">await</span> fetchUsers()</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨å¼‚æ­¥åºåˆ—å¯ä»¥æœ‰æ•ˆåœ°ç”Ÿæˆä¸€ä¸ªè¿­ä»£å™¨ï¼Œç„¶åé‡å¤è°ƒç”¨å®ƒçš„ <code>next()</code> ç›´åˆ°å®ƒè¿”å› <code>nil</code> ï¼Œæ­¤æ—¶å¾ªç¯ç»“æŸã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">printUsers</span>() <span class="keyword">async</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/users.csv&quot;</span>)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> iterator <span class="operator">=</span> url.lines.makeAsyncIterator()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> line <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> iterator.next() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The first user is <span class="subst">\(line)</span>&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">2</span> <span class="operator">...</span> <span class="number">5</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> line <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> iterator.next() &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;User #<span class="subst">\(i)</span>: <span class="subst">\(line)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> remainingResults <span class="operator">=</span> [<span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> iterator.next() &#123;</span><br><span class="line">    remainingResults.append(result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;There were <span class="subst">\(remainingResults.count)</span> other users.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try?</span> <span class="keyword">await</span> printUsers()</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨-map-filter-ç­‰æ“ä½œ-asyncsequence"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-map-filter-ç­‰æ“ä½œ-asyncsequence"></a> ä½¿ç”¨ map ()ã€filter () ç­‰æ“ä½œ AsyncSequence</h3>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">getQuotes</span>() <span class="keyword">async</span> -&gt; <span class="keyword">some</span> <span class="type">AsyncSequence</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/quotes.txt&quot;</span>)<span class="operator">!</span></span><br><span class="line">  <span class="keyword">let</span> anonymousQuotes <span class="operator">=</span> url.lines.filter &#123; <span class="variable">$0</span>.contains(<span class="string">&quot;Anonymous&quot;</span>) &#125;</span><br><span class="line">  <span class="keyword">let</span> topAnonymousQuotes <span class="operator">=</span> anonymousQuotes.prefix(<span class="number">5</span>)</span><br><span class="line">  <span class="keyword">let</span> shoutingTopAnonymousQuotes <span class="operator">=</span> topAnonymousQuotes.map(\.localizedUppercase)</span><br><span class="line">  <span class="keyword">return</span> shoutingTopAnonymousQuotes</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">await</span> getQuotes()</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">try</span> <span class="keyword">await</span> quote <span class="keyword">in</span> result &#123;</span><br><span class="line">    <span class="built_in">print</span>(quote)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Error fetching quotes&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ï¼Œæ‰€æœ‰è½¬æ¢éƒ½åˆ›å»ºäº†æ–°çš„å¼‚æ­¥åºåˆ—ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å°†å®ƒä»¬ä¸ <code>await</code> ä¸€èµ·ä½¿ç”¨ï¼Œä½†è®¸å¤šè½¬æ¢ä¹Ÿä¼šç”Ÿæˆå•ä¸ªå€¼ã€‚è¿™äº›å¿…é¡»ä½¿ç”¨ <code>await</code> æ‰èƒ½æŒ‚èµ·ï¼Œç›´åˆ°è¿”å›åºåˆ—çš„æ‰€æœ‰éƒ¨åˆ†ï¼Œå¹¶ä¸”å¦‚æœåºåˆ—æŠ›å‡ºï¼Œå¯èƒ½è¿˜éœ€è¦ä½¿ç”¨ <code>try</code>ã€‚ä¾‹å¦‚ï¼Œ <code>allSatisfy()</code>ï¼Œæ£€æŸ¥å¼‚æ­¥åºåˆ—ä¸­çš„æ‰€æœ‰å…ƒç´ æ˜¯å¦éƒ½é€šè¿‡æ‚¨é€‰æ‹©çš„è°“è¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">checkQuotes</span>() <span class="keyword">async</span> <span class="keyword">throws</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/quotes.txt&quot;</span>)<span class="operator">!</span></span><br><span class="line">  <span class="keyword">let</span> noShortQuotes <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> url.lines.allSatisfy &#123; <span class="variable">$0</span>.count <span class="operator">&gt;</span> <span class="number">30</span> &#125;</span><br><span class="line">  <span class="built_in">print</span>(noShortQuotes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try?</span> <span class="keyword">await</span> checkQuotes()</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–ç±»ä¼¼çš„å‡½æ•°ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¾‹å¦‚ <code>min()</code> ã€ <code>max()</code> å’Œ <code>reduce()</code>ã€‚</p>
<h3 id="åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥åºåˆ—"><a class="markdownIt-Anchor" href="#åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥åºåˆ—"></a> åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥åºåˆ—</h3>
<p>åˆ›å»º <code>AsyncSequence</code>ï¼š</p>
<ul>
<li>éœ€è¦éµå®ˆ <code>AsyncSequence</code> å’Œ <code>AsyncIteratorProtocol</code> åè®®</li>
<li>è¿­ä»£å™¨çš„ <code>next()</code> æ–¹æ³•å¿…é¡»æ ‡è®°ä¸º <code>async</code></li>
<li>éœ€è¦åˆ›å»ºä¸€ä¸ª <code>makeAsyncIterator()</code> æ–¹æ³•</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æ¯æ¬¡è°ƒç”¨ next() æ—¶æ•°å­—éƒ½ä¼šåŠ å€çš„å¼‚æ­¥åºåˆ—ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">DoubleGenerator</span>: <span class="title class_">AsyncSequence</span>, <span class="title class_">AsyncIteratorProtocol</span> &#123;</span><br><span class="line">  <span class="keyword">typealias</span> <span class="type">Element</span> <span class="operator">=</span> <span class="type">Int</span></span><br><span class="line">  <span class="keyword">var</span> current <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">mutating</span> <span class="keyword">func</span> <span class="title function_">next</span>() <span class="keyword">async</span> -&gt; <span class="type">Element</span>? &#123;</span><br><span class="line">    <span class="keyword">defer</span> &#123; current <span class="operator">&amp;*=</span> <span class="number">2</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current <span class="operator">&lt;</span> <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> current</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">makeAsyncIterator</span>() -&gt; <span class="type">DoubleGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sequence <span class="operator">=</span> <span class="type">DoubleGenerator</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="keyword">await</span> number <span class="keyword">in</span> sequence &#123;</span><br><span class="line">  <span class="built_in">print</span>(number)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ï¼šåœ¨ Swift ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œ<code>&amp;*=</code> æ˜¯ä¸€ä¸ªå¤åˆèµ‹å€¼è¿ç®—ç¬¦ï¼Œç”¨äºæ‰§è¡Œå¸¦ç¬¦å·æ•´æ•°çš„æº¢å‡ºä¹˜æ³•æ“ä½œã€‚è¯¥è¿ç®—ç¬¦ç»“åˆäº†æº¢å‡ºä¹˜æ³•è¿ç®—ç¬¦ <code>&amp;*</code> å’Œèµ‹å€¼è¿ç®—ç¬¦ <code>=</code>ã€‚å®ƒå¯ä»¥ç¡®ä¿åœ¨è®¡ç®—ç»“æœè¶…å‡ºå˜é‡å­˜å‚¨èŒƒå›´æ—¶ï¼Œä¸ä¼šæŠ›å‡ºæº¢å‡ºé”™è¯¯ï¼Œè€Œæ˜¯ä¿ç•™æº¢å‡ºçš„ç»“æœã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a: <span class="type">Int</span> <span class="operator">=</span> <span class="type">Int</span>.max</span><br><span class="line">a <span class="operator">&amp;*=</span> <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">// è¾“å‡ºä¸º -2</span></span><br></pre></td></tr></table></figure>
<h3 id="å°†-asyncsequence-è½¬æ¢ä¸º-sequence"><a class="markdownIt-Anchor" href="#å°†-asyncsequence-è½¬æ¢ä¸º-sequence"></a> å°† AsyncSequence è½¬æ¢ä¸º Sequence</h3>
<p>æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨åºåˆ—ä¸Šè°ƒç”¨ <code>reduce(into:)</code>ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extension</span> <span class="title class_">AsyncSequence</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">collect</span>() <span class="keyword">async</span> <span class="keyword">rethrows</span> -&gt; [<span class="type">Element</span>] &#123;</span><br><span class="line">    <span class="keyword">try</span> <span class="keyword">await</span> reduce(into: [<span class="type">Element</span>]()) &#123; <span class="variable">$0</span>.append(<span class="variable">$1</span>) &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="task"><a class="markdownIt-Anchor" href="#task"></a> Task</h2>
<p>åœ¨ Swift ä¸­ä½¿ç”¨ <code>async/await</code> å…è®¸æˆ‘ä»¬ç¼–å†™æ˜“äºé˜…è¯»å’Œç†è§£çš„å¼‚æ­¥ä»£ç ï¼Œä½†å®ƒæœ¬èº«ä»ç„¶ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚ä¸ºäº†åˆ›å»ºå®é™…çš„å¹¶å‘æ€§ï¼ˆæä¾›åŒæ—¶è¿è¡Œå¤šä¸ªå·¥ä½œçš„èƒ½åŠ›ï¼‰ï¼ŒSwift ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§ç‰¹å®šçš„ç±»å‹ï¼š <code>Task</code> å’Œ <code>TaskGroup</code>ã€‚</p>
<p>å¦‚æœåªæ˜¯å¼€å§‹ä¸€ä¸¤ä¸ªç‹¬ç«‹çš„å·¥ä½œï¼Œé‚£ä¹ˆ <code>Task</code> æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚å¦‚æœæƒ³å°†ä¸€é¡¹ä½œä¸šæ‹†åˆ†ä¸ºå¤šä¸ªå¹¶å‘æ“ä½œï¼Œé‚£ä¹ˆ <code>TaskGroup</code> æ›´é€‚åˆã€‚</p>
<p><code>Task</code> å’Œ <code>TaskGroup</code> çš„ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ä¾æ¬¡æ˜¯ <code>high</code>ã€<code>medium</code>ã€<code>low</code>ã€<code>background</code>ã€‚ä¸ DispatchQueue çš„ quality-of-service ç›¸æ¯”ï¼Œ<code>.high</code> ç­‰åŒäº <code>.userInitiated</code>ï¼Œ<code>.low</code> ç­‰åŒäº <code>.utility</code>ã€‚</p>
<h3 id="task-çš„åˆ›å»ºå’Œè¿è¡Œ"><a class="markdownIt-Anchor" href="#task-çš„åˆ›å»ºå’Œè¿è¡Œ"></a> Task çš„åˆ›å»ºå’Œè¿è¡Œ</h3>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">NewsItem</span>: <span class="title class_">Decodable</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">  <span class="keyword">let</span> title: <span class="type">String</span></span><br><span class="line">  <span class="keyword">let</span> url: <span class="type">URL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HighScore</span>: <span class="title class_">Decodable</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">  <span class="keyword">let</span> score: <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchUpdates</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> newsTask <span class="operator">=</span> <span class="type">Task</span> &#123; () -&gt; [<span class="type">NewsItem</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/headlines.json&quot;</span>)<span class="operator">!</span></span><br><span class="line">    <span class="keyword">let</span> (data, <span class="keyword">_</span>) <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> <span class="type">URLSession</span>.shared.data(from: url)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode([<span class="type">NewsItem</span>].<span class="keyword">self</span>, from: data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> highScoreTask <span class="operator">=</span> <span class="type">Task</span> &#123; () -&gt; [<span class="type">HighScore</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/scores.json&quot;</span>)<span class="operator">!</span></span><br><span class="line">    <span class="keyword">let</span> (data, <span class="keyword">_</span>) <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> <span class="type">URLSession</span>.shared.data(from: url)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode([<span class="type">HighScore</span>].<span class="keyword">self</span>, from: data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> news <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> newsTask.value</span><br><span class="line">    <span class="keyword">let</span> highScores <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> highScoreTask.value</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Latest news loaded with <span class="subst">\(news.count)</span> items.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> topScore <span class="operator">=</span> highScores.first &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\(topScore.name)</span> has the highest score with <span class="subst">\(topScore.score)</span>, out of <span class="subst">\(highScores.count)</span> total results.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;There was an error loading user data.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> fetchUpdates()</span><br></pre></td></tr></table></figure>
<ul>
<li>Taxks å¹¶ä¸æ€»æ˜¯éœ€è¦è¿”å›å€¼ï¼Œè¿™é‡Œçš„è¿”å›å€¼æ˜¯ <code>[NewsItem]</code>ï¼›</li>
<li>ä¸€æ—¦åˆ›å»ºäº†ä»»åŠ¡ï¼Œå®ƒå°±ä¼šå¼€å§‹è¿è¡Œï¼›</li>
<li>å¦‚æœè¦è¯»å–ä»»åŠ¡çš„è¿”å›å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>await</code> è®¿é—®å…¶ <code>value</code> å±æ€§ã€‚</li>
</ul>
<h3 id="detached-task"><a class="markdownIt-Anchor" href="#detached-task"></a> Detached Task</h3>
<p><code>Task</code> ä¼šç»§æ‰¿å¹¶è¿è¡Œåœ¨è°ƒç”¨å®ƒçš„å½“å‰ä»»åŠ¡çš„æ‰§è¡Œç¯å¢ƒå’Œä¼˜å…ˆçº§ä¸‹ã€‚å®ƒé€šå¸¸ç”¨äºåˆ›å»ºä¸€ä¸ªé™„å±äºå½“å‰ä¸Šä¸‹æ–‡çš„ä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥å…±äº«å½“å‰ä¸Šä¸‹æ–‡çš„ä¸€äº›ç‰¹æ€§ï¼Œä¾‹å¦‚ï¼šActor çš„éš”ç¦»çŠ¶æ€æˆ–ç»“æ„åŒ–å¹¶å‘çš„èŒƒå›´ã€‚</p>
<p><code>Task.detached</code> ä¼šåˆ›å»ºä¸€ä¸ªä¸å½“å‰ä¸Šä¸‹æ–‡åˆ†ç¦»çš„ç‹¬ç«‹ä»»åŠ¡ã€‚å®ƒä¸ä¼šç»§æ‰¿åˆ›å»ºå®ƒçš„ä¸Šä¸‹æ–‡çš„ä¼˜å…ˆçº§å’Œä»»åŠ¡çŠ¶æ€ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªå…¨æ–°çš„ä»»åŠ¡æ¥æ‰§è¡Œã€‚é€šå¸¸åœ¨éœ€è¦å®Œå…¨ç‹¬ç«‹çš„å¹¶å‘æ‰§è¡Œæ—¶ä½¿ç”¨ <code>Task.detached</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ViewModel</span>: <span class="title class_">ObservableObject</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ContentView</span>: <span class="title class_">View</span> &#123;</span><br><span class="line">  <span class="meta">@StateObject</span> <span class="keyword">private</span> <span class="keyword">var</span> model <span class="operator">=</span> <span class="type">ViewModel</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">View</span> &#123;</span><br><span class="line">    <span class="type">Button</span>(<span class="string">&quot;Authenticate&quot;</span>, action: doWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">doWork</span>() &#123;</span><br><span class="line">    <span class="type">Task</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span><span class="operator">...</span><span class="number">10_000</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;In Task 1: <span class="subst">\(i)</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Task</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1</span><span class="operator">...</span><span class="number">10_000</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;In Task 2: <span class="subst">\(i)</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­çš„ä¸¤ä¸ª <code>Task</code>ï¼Œä½†å®ƒä»¬ä¹Ÿæ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼Œå› ä¸º <code>@StateObject</code> è§†å›¾æ¨¡å‹å°†æ•´ä¸ªè§†å›¾å¼ºåˆ¶åˆ° <code>main actor</code> ä¸Šï¼Œè¿™æ„å‘³ç€å®ƒä¸€æ¬¡åªèƒ½åšä¸€ä»¶äº‹ã€‚è¿™æ—¶ï¼Œå°† <code>Task</code> æ›´æ”¹ä¸º <code>Task.detached</code>ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡å°±å¯ä»¥åŒæ—¶è¿è¡Œã€‚</p>
<h3 id="ä»ä»»åŠ¡ä¸­è·å–ç»“æœ"><a class="markdownIt-Anchor" href="#ä»ä»»åŠ¡ä¸­è·å–ç»“æœ"></a> ä»ä»»åŠ¡ä¸­è·å–ç»“æœ</h3>
<p>å¦‚æœä½ æƒ³ç›´æ¥è¯»å–ä¸€ä¸ªä»»åŠ¡ï¼ˆTaskï¼‰çš„è¿”å›å€¼ï¼Œåº”è¯¥ä½¿ç”¨ <code>await</code> æ¥è¯»å–å…¶å€¼ï¼Œæˆ–è€…å¦‚æœå®ƒåŒ…å«æŠ›å‡ºæ“ä½œï¼ˆthrowing operationï¼‰ï¼Œåˆ™ä½¿ç”¨ <code>try await</code>ã€‚ç„¶è€Œï¼Œæ‰€æœ‰ä»»åŠ¡ä¹Ÿéƒ½æœ‰ä¸€ä¸ª <code>result</code> å±æ€§ï¼Œè¯¥å±æ€§è¿”å›ä¸€ä¸ª Swift çš„ <code>Result</code> ç»“æ„å®ä¾‹ï¼Œæ³›å‹åŒ–ä¸ºä»»åŠ¡è¿”å›çš„ç±»å‹ä»¥åŠå®ƒæ˜¯å¦å¯èƒ½åŒ…å«é”™è¯¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">LoadError</span>: <span class="title class_">Error</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> fetchFailed, decodeFailed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">fetchQuotes</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> downloadTask <span class="operator">=</span> <span class="type">Task</span> &#123; () -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/quotes.txt&quot;</span>)<span class="operator">!</span></span><br><span class="line">    <span class="keyword">let</span> data: <span class="type">Data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      (data, <span class="keyword">_</span>) <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> <span class="type">URLSession</span>.shared.data(from: url)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="type">LoadError</span>.fetchFailed</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> string <span class="operator">=</span> <span class="type">String</span>(data: data, encoding: .utf8) &#123;</span><br><span class="line">      <span class="keyword">return</span> string</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="type">LoadError</span>.decodeFailed</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">await</span> downloadTask.result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> string <span class="operator">=</span> <span class="keyword">try</span> result.get()</span><br><span class="line">    <span class="built_in">print</span>(string)</span><br><span class="line">  &#125; <span class="keyword">catch</span> <span class="type">LoadError</span>.fetchFailed &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Unable to fetch the quotes.&quot;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> <span class="type">LoadError</span>.decodeFailed &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Unable to convert quotes to text.&quot;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Unknown error.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> fetchQuotes()</span><br></pre></td></tr></table></figure>
<h3 id="ä»»åŠ¡ä¼˜å…ˆçº§"><a class="markdownIt-Anchor" href="#ä»»åŠ¡ä¼˜å…ˆçº§"></a> ä»»åŠ¡ä¼˜å…ˆçº§</h3>
<p>åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Task</span>(priority: .high) &#123; () -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">  <span class="comment">// More code here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æ‚¨å¯ä»¥åœ¨åˆ›å»ºä»»åŠ¡æ—¶ç›´æ¥ä¸ºå…¶åˆ†é…ä¼˜å…ˆçº§ï¼Œä½†å¦‚æœä¸æŒ‡å®šä¼˜å…ˆçº§ï¼ŒSwift å°†éµå¾ªä¸‰ä¸ªè§„åˆ™è‡ªåŠ¨ç¡®å®šä¼˜å…ˆçº§ï¼š</p>
<ol>
<li>å¦‚æœè¯¥ä»»åŠ¡æ˜¯ä»å¦ä¸€ä¸ªä»»åŠ¡åˆ›å»ºçš„ï¼Œåˆ™å­ä»»åŠ¡å°†ç»§æ‰¿çˆ¶ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚</li>
<li>å¦‚æœæ–°ä»»åŠ¡æ˜¯ç›´æ¥ä»ä¸»çº¿ç¨‹è€Œä¸æ˜¯ä»»åŠ¡åˆ›å»ºçš„ï¼Œåˆ™ä¼šè‡ªåŠ¨ä¸ºå…¶åˆ†é…æœ€é«˜ä¼˜å…ˆçº§ <code>.userInitiated</code> ã€‚</li>
<li>å¦‚æœæ–°ä»»åŠ¡ä¸æ˜¯ç”±å¦ä¸€ä¸ªä»»åŠ¡æˆ–ä¸»çº¿ç¨‹åˆ›å»ºçš„ï¼ŒSwift å°†å°è¯•æŸ¥è¯¢çº¿ç¨‹çš„ä¼˜å…ˆçº§æˆ–ä¸ºå…¶èµ‹äºˆ <code>nil</code> ä¼˜å…ˆçº§ã€‚</li>
</ol>
<p>ä»»ä½•ä»»åŠ¡éƒ½å¯ä»¥ä½¿ç”¨ <code>Task.currentPriority</code> æŸ¥è¯¢å…¶å½“å‰ä¼˜å…ˆçº§ã€‚</p>
<h3 id="ä¼˜å…ˆçº§å‡çº§"><a class="markdownIt-Anchor" href="#ä¼˜å…ˆçº§å‡çº§"></a> ä¼˜å…ˆçº§å‡çº§</h3>
<p>æ¯ä¸ªä»»åŠ¡éƒ½å¯ä»¥åˆ›å»ºä¸ºå…·æœ‰ç‰¹å®šçš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå¯ä»¥ä»å…¶ä»–åœ°æ–¹ç»§æ‰¿ä¼˜å…ˆçº§ã€‚ä½†åœ¨ä¸¤ç§ç‰¹å®šæƒ…å†µä¸‹ï¼ŒSwift ä¼šæé«˜ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ›´å¿«åœ°å®Œæˆã€‚</p>
<ol>
<li>å¦‚æœè¾ƒé«˜ä¼˜å…ˆçº§ä»»åŠ¡ A å¼€å§‹ç­‰å¾…è¾ƒä½ä¼˜å…ˆçº§ä»»åŠ¡ B çš„ç»“æœï¼Œåˆ™ä»»åŠ¡ B çš„ä¼˜å…ˆçº§å°†æå‡åˆ°ä¸ä»»åŠ¡ A ç›¸åŒçš„ä¼˜å…ˆçº§ã€‚</li>
<li>å¦‚æœè¾ƒä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ A å·²å¼€å§‹åœ¨æŸä¸ª Actor ä¸Šè¿è¡Œï¼Œå¹¶ä¸”è¾ƒé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ B å·²åœ¨è¯¥ Actor ä¸Šæ’é˜Ÿï¼Œåˆ™ä»»åŠ¡ A çš„ä¼˜å…ˆçº§å°†æå‡ä»¥åŒ¹é…ä»»åŠ¡ Bã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œç¬¬ 2 ç§æƒ…å†µä¸‹ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå…¶ä¼˜å…ˆçº§ä¼šå‡çº§ï¼Œä½†ä¸ä¼šæ”¹å˜å…¶ <code>currentPriority</code> çš„å€¼ã€‚</p>
<h3 id="å–æ¶ˆä»»åŠ¡"><a class="markdownIt-Anchor" href="#å–æ¶ˆä»»åŠ¡"></a> å–æ¶ˆä»»åŠ¡</h3>
<p>è™½ç„¶æˆ‘ä»¬å¯ä»¥å‘Šè¯‰ä»»åŠ¡åœæ­¢å·¥ä½œï¼Œä½†ä»»åŠ¡æœ¬èº«å¯ä»¥å®Œå…¨å¿½ç•¥è¯¥æŒ‡ä»¤å¹¶æ ¹æ®éœ€è¦ç»§ç»­æ‰§è¡Œã€‚</p>
<ol>
<li>å¯ä»¥é€šè¿‡è°ƒç”¨ä»»åŠ¡çš„ <code>cancel()</code> æ–¹æ³•æ˜¾å¼å–æ¶ˆä»»åŠ¡ã€‚</li>
<li>å¯ä»¥æ£€æŸ¥ <code>Task.isCancelled</code> æ¥ç¡®å®šä»»åŠ¡æ˜¯å¦å·²è¢«å–æ¶ˆã€‚</li>
<li>å¯ä»¥è°ƒç”¨ <code>Task.checkCancellation()</code> æ–¹æ³•ï¼Œå¦‚æœä»»åŠ¡å·²å–æ¶ˆï¼Œè¯¥æ–¹æ³•å°†æŠ›å‡º <code>CancellationError</code>ï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚</li>
<li>Foundation çš„æŸäº›éƒ¨åˆ†ä¼šè‡ªåŠ¨æ£€æŸ¥ä»»åŠ¡å–æ¶ˆæƒ…å†µï¼Œå³ä½¿æ²¡æœ‰ä½ çš„è¾“å…¥ä¹Ÿä¼šæŠ›å‡ºå®ƒä»¬è‡ªå·±çš„å–æ¶ˆé”™è¯¯</li>
<li>å¦‚æœä½ ä½¿ç”¨ <code>Task.sleep()</code> æ¥ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå–æ¶ˆä½ çš„ä»»åŠ¡å°†è‡ªåŠ¨ç»ˆæ­¢ç­‰å¾…å¹¶æŠ›å‡º <code>CancellationError</code>ã€‚</li>
<li>å¦‚æœä»»åŠ¡æ˜¯ä¸€ä¸ªç»„çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ç»„çš„ä»»ä½•éƒ¨åˆ†æŠ›å‡ºé”™è¯¯ï¼Œå…¶ä»–ä»»åŠ¡å°†è¢«å–æ¶ˆå¹¶ç­‰å¾…ã€‚</li>
<li>å¦‚æœä½ ä½¿ç”¨ SwiftUI çš„ <code>task()</code> ä¿®é¥°ç¬¦å¯åŠ¨äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡å°†åœ¨è§†å›¾æ¶ˆå¤±æ—¶è‡ªåŠ¨å–æ¶ˆã€‚</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">getAverageTemperature</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> fetchTask <span class="operator">=</span> <span class="type">Task</span> &#123; () -&gt; <span class="type">Double</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/readings.json&quot;</span>)<span class="operator">!</span></span><br><span class="line">    <span class="keyword">let</span> (data, <span class="keyword">_</span>) <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> <span class="type">URLSession</span>.shared.data(from: url)</span><br><span class="line">    <span class="keyword">try</span> <span class="type">Task</span>.checkCancellation()</span><br><span class="line">    <span class="keyword">let</span> readings <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode([<span class="type">Double</span>].<span class="keyword">self</span>, from: data)</span><br><span class="line">    <span class="keyword">let</span> sum <span class="operator">=</span> readings.reduce(<span class="number">0</span>, <span class="operator">+</span>)</span><br><span class="line">    <span class="keyword">return</span> sum <span class="operator">/</span> <span class="type">Double</span>(readings.count)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> fetchTask.value</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Average temperature: <span class="subst">\(result)</span>&quot;</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to get data.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> getAverageTemperature()</span><br></pre></td></tr></table></figure>
<p><code>URLSession.shared.data(from:)</code> å­˜åœ¨éšå¼å–æ¶ˆï¼Œå…¶è°ƒç”¨å°†åœ¨ç»§ç»­ä¹‹å‰æ£€æŸ¥å…¶ä»»åŠ¡æ˜¯å¦ä»å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚å¦‚æœä»»åŠ¡å·²è¢«å–æ¶ˆï¼Œ<code>data(from:)</code> å°†è‡ªåŠ¨æŠ›å‡º <code>URLError</code> å¹¶ä¸”ä»»åŠ¡çš„å…¶ä½™éƒ¨åˆ†å°†ä¸ä¼šæ‰§è¡Œã€‚<br />
è¿™é‡Œä½¿ç”¨ <code>Task.checkCancellation()</code>ï¼Œä»¥åœ¨ç½‘ç»œè¯·æ±‚åæ˜¾å¼æ£€æŸ¥å–æ¶ˆã€‚</p>
<p>ä¸‹é¢çš„ä»£ç åœ¨ä»»åŠ¡åˆ›å»ºåç«‹å³å–æ¶ˆä»»åŠ¡ï¼Œå¹¶è¿”å›é»˜è®¤å€¼ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">getAverageTemperature</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> fetchTask <span class="operator">=</span> <span class="type">Task</span> &#123; () -&gt; <span class="type">Double</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: <span class="string">&quot;https://hws.dev/readings.json&quot;</span>)<span class="operator">!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> (data, <span class="keyword">_</span>) <span class="operator">=</span> <span class="keyword">try</span> <span class="keyword">await</span> <span class="type">URLSession</span>.shared.data(from: url)</span><br><span class="line">      <span class="keyword">if</span> <span class="type">Task</span>.isCancelled &#123; <span class="keyword">return</span> <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> readings <span class="operator">=</span> <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode([<span class="type">Double</span>].<span class="keyword">self</span>, from: data)</span><br><span class="line">      <span class="keyword">let</span> sum <span class="operator">=</span> readings.reduce(<span class="number">0</span>, <span class="operator">+</span>)</span><br><span class="line">      <span class="keyword">return</span> sum <span class="operator">/</span> <span class="type">Double</span>(readings.count)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fetchTask.cancel()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">await</span> fetchTask.value</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Average temperature: <span class="subst">\(result)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> getAverageTemperature()</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªé€šè¿‡ <code>data(from:)</code> è°ƒç”¨çš„éšå¼å–æ¶ˆç‚¹ï¼Œä»¥åŠä¸€ä¸ªé€šè¿‡ <code>Task.isCancelled</code> æ£€æŸ¥çš„æ˜¾å¼å–æ¶ˆç‚¹ã€‚å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªè¢«è§¦å‘ï¼Œä»»åŠ¡å°†è¿”å› 0 è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯ã€‚</p>
<h3 id="ä¼‘çœ ä»»åŠ¡"><a class="markdownIt-Anchor" href="#ä¼‘çœ ä»»åŠ¡"></a> ä¼‘çœ ä»»åŠ¡</h3>
<p>ä½¿å½“å‰ä»»åŠ¡ä¼‘çœ è‡³å°‘ 3 ç§’ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> <span class="keyword">await</span> <span class="type">Task</span>.sleep(nanoseconds: <span class="number">3_000_000_000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>éœ€è¦ä½¿ç”¨ <code>await</code> è°ƒç”¨ <code>Task.sleep()</code>ï¼›</li>
<li>éœ€è¦ä½¿ç”¨ <code>try</code> ï¼Œå› ä¸º <code>Task.sleep()</code> ä¼šè‡ªåŠ¨æ£€æŸ¥å–æ¶ˆï¼Œå¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œå°†ä¼šæŠ›å‡ºä¸€ä¸ª <code>CancellationError</code> é”™è¯¯ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šè°ƒç”¨ <code>Task.sleep()</code> å°†ä½¿å½“å‰ä»»åŠ¡è‡³å°‘ä¼‘çœ æ‚¨è¦æ±‚çš„æ—¶é—´ï¼Œè€Œä¸æ˜¯æ‚¨è¦æ±‚çš„ç¡®åˆ‡æ—¶é—´ã€‚å› ä¸ºå½“ç¡çœ ç»“æŸæ—¶ç³»ç»Ÿå¯èƒ½æ­£å¿™äºåšå…¶ä»–å·¥ä½œã€‚</p>
<p>å¦å¤–ï¼Œä¸ä½¿çº¿ç¨‹ä¼‘çœ ä¸åŒï¼Œ<code>Task.sleep()</code> ä¸ä¼šé˜»å¡åº•å±‚çº¿ç¨‹ï¼Œå› æ­¤åœ¨éœ€è¦æ—¶å®ƒå¯ä»¥ä»å…¶ä»–åœ°æ–¹è·å–å·¥ä½œã€‚</p>
<h3 id="ä¸»åŠ¨æš‚åœä»»åŠ¡"><a class="markdownIt-Anchor" href="#ä¸»åŠ¨æš‚åœä»»åŠ¡"></a> ä¸»åŠ¨æš‚åœä»»åŠ¡</h3>
<p>å¯ä»¥è°ƒç”¨ <code>Task.yield()</code> æ¥è‡ªåŠ¨æŒ‚èµ·å½“å‰ä»»åŠ¡ã€‚ä½†è°ƒç”¨ <code>yield()</code> å¹¶ä¸æ€»æ˜¯æ„å‘³ç€ä»»åŠ¡ä¼šåœæ­¢è¿è¡Œï¼šå¦‚æœå®ƒçš„ä¼˜å…ˆçº§é«˜äºå…¶ä»–ç­‰å¾…çš„ä»»åŠ¡ï¼Œä½ çš„ä»»åŠ¡å®Œå…¨æœ‰å¯èƒ½ç«‹å³æ¢å¤å·¥ä½œã€‚å°†å…¶è§†ä¸ºä¸€ç§æŒ‡å¯¼â€”â€”æˆ‘ä»¬åªæ˜¯ç»™ Swift ä¸€ä¸ªä¸´æ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡çš„æœºä¼šï¼Œè€Œä¸æ˜¯å¼ºåˆ¶å®ƒè¿™æ ·åšã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">factors</span>(<span class="params">for</span> <span class="params">number</span>: <span class="type">Int</span>) <span class="keyword">async</span> -&gt; [<span class="type">Int</span>] &#123;</span><br><span class="line">  <span class="keyword">var</span> result <span class="operator">=</span> [<span class="type">Int</span>]()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> check <span class="keyword">in</span> <span class="number">1</span> <span class="operator">...</span> number &#123;</span><br><span class="line">    <span class="keyword">if</span> number.isMultiple(of: check) &#123;</span><br><span class="line">      result.append(check)</span><br><span class="line">      <span class="keyword">await</span> <span class="type">Task</span>.yield()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> factors <span class="operator">=</span> <span class="keyword">await</span> factors(for: <span class="number">120</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Found <span class="subst">\(factors.count)</span> factors for 120.&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="task-group"><a class="markdownIt-Anchor" href="#task-group"></a> Task Group</h2>
<h3 id="åˆ›å»ºä»»åŠ¡ç»„å¹¶å‘å…¶ä¸­æ·»åŠ ä»»åŠ¡"><a class="markdownIt-Anchor" href="#åˆ›å»ºä»»åŠ¡ç»„å¹¶å‘å…¶ä¸­æ·»åŠ ä»»åŠ¡"></a> åˆ›å»ºä»»åŠ¡ç»„å¹¶å‘å…¶ä¸­æ·»åŠ ä»»åŠ¡</h3>
<p>å¹¶ä¸æ˜¯ç›´æ¥åˆ›å»º <code>TaskGroup</code> å®ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨ <code>withTaskGroup(of:)</code> å‡½æ•°ï¼Œå¹¶å‘Šè¯‰å®ƒä»»åŠ¡ç»„å°†è¿”å›çš„æ•°æ®ç±»å‹ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå®ƒè¿”å› 5 ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶åå°†è¯¥æ•°ç»„è¿æ¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">printMessage</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> string <span class="operator">=</span> <span class="keyword">await</span> withTaskGroup(of: <span class="type">String</span>.<span class="keyword">self</span>) &#123; group -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    group.addTask &#123; <span class="string">&quot;Hello&quot;</span> &#125;</span><br><span class="line">    group.addTask &#123; <span class="string">&quot;From&quot;</span> &#125;</span><br><span class="line">    group.addTask &#123; <span class="string">&quot;A&quot;</span> &#125;</span><br><span class="line">    group.addTask &#123; <span class="string">&quot;Task&quot;</span> &#125;</span><br><span class="line">    group.addTask &#123; <span class="string">&quot;Group&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> collected <span class="operator">=</span> [<span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">await</span> value <span class="keyword">in</span> group &#123;</span><br><span class="line">      collected.append(value)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> collected.joined(separator: <span class="string">&quot; &quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> printMessage()</span><br></pre></td></tr></table></figure>
<ol>
<li>æˆ‘ä»¬å¿…é¡»æŒ‡å®šä»»åŠ¡ç»„å°†è¿”å›çš„æ•°æ®çš„ç¡®åˆ‡ç±»å‹ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ <code>String.self</code> ï¼Œä»¥ä¾¿æ¯ä¸ªå­ä»»åŠ¡éƒ½å¯ä»¥è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</li>
<li>æˆ‘ä»¬éœ€è¦ä½¿ç”¨ <code>group -&gt; String in</code> å‡†ç¡®æŒ‡å®šç»„çš„è¿”å›å€¼ã€‚</li>
<li>å¯¹äºè¦æ·»åŠ åˆ°ç»„ä¸­çš„æ¯ä¸ªä»»åŠ¡ï¼Œå¯ä»¥è°ƒç”¨ <code>addTask()</code>ã€‚</li>
<li>ä»»åŠ¡ç»„ç¬¦åˆ <code>AsyncSequence</code> ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>for await</code> æˆ–é‡å¤è°ƒç”¨ <code>group.next()</code> ä»å…¶å­çº§è¯»å–æ‰€æœ‰å€¼ã€‚</li>
<li>å› ä¸ºæ•´ä¸ªä»»åŠ¡ç»„æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ <code>await</code> æ¥è°ƒç”¨å®ƒã€‚</li>
<li>æ³¨æ„è¿”å›çš„ç»“æœæ˜¯æŒ‰å®Œæˆé¡ºåºè€Œä¸æ˜¯åˆ›å»ºçš„é¡ºåºã€‚</li>
<li>ä½¿ç”¨ <code>withTaskGroup()</code> åˆ›å»ºçš„ä»»åŠ¡ä¸èƒ½æŠ›å‡ºé”™è¯¯ã€‚å¦‚æœæ‚¨å¸Œæœ›å®ƒä»¬èƒ½å¤ŸæŠ›å‡ºå‘ä¸Šå†’æ³¡çš„é”™è¯¯ï¼ˆå³åœ¨ä»»åŠ¡ç»„ä¹‹å¤–å¤„ç†çš„é”™è¯¯ï¼‰ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨ <code>withThrowingTaskGroup()</code> æ¥ä»£æ›¿ã€‚</li>
</ol>
<p>æ— è®ºæ‚¨ä½¿ç”¨çš„æ˜¯æŠ›å‡ºä»»åŠ¡è¿˜æ˜¯éæŠ›å‡ºä»»åŠ¡ï¼Œç»„ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å¿…é¡»åœ¨ç»„è¿”å›ä¹‹å‰å®Œæˆã€‚æ‚¨åœ¨è¿™é‡Œæœ‰ä¸‰ä¸ªé€‰æ‹©ï¼š</p>
<ol>
<li>ç­‰å¾…ç»„ä¸­çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚</li>
<li>è°ƒç”¨ <code>waitForAll()</code> å°†è‡ªåŠ¨ç­‰å¾…æ‚¨æœªæ˜ç¡®ç­‰å¾…çš„ä»»åŠ¡ï¼Œå¹¶ä¸¢å¼ƒå®ƒä»¬è¿”å›çš„ä»»ä½•ç»“æœã€‚</li>
<li>å¦‚æœæ‚¨æ²¡æœ‰æ˜¾å¼ç­‰å¾…ä»»ä½•å­ä»»åŠ¡ï¼Œå®ƒä»¬å°†è¢«éšå¼ç­‰å¾… - Swift æ— è®ºå¦‚ä½•éƒ½ä¼šç­‰å¾…å®ƒä»¬ï¼Œå³ä½¿æ‚¨æ²¡æœ‰ä½¿ç”¨å®ƒä»¬çš„è¿”å›å€¼ã€‚</li>
</ol>
<h3 id="å–æ¶ˆä»»åŠ¡ç»„"><a class="markdownIt-Anchor" href="#å–æ¶ˆä»»åŠ¡ç»„"></a> å–æ¶ˆä»»åŠ¡ç»„</h3>
<p>Swift çš„ä»»åŠ¡ç»„å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ç§æ–¹å¼ä¹‹ä¸€å–æ¶ˆï¼š</p>
<ol>
<li>å¦‚æœä»»åŠ¡ç»„çš„çˆ¶ä»»åŠ¡è¢«å–æ¶ˆã€‚</li>
<li>å¦‚æœæ‚¨åœ¨ç»„ä¸Šæ˜ç¡®è°ƒç”¨ <code>cancelAll()</code>ã€‚</li>
<li>å¦‚æœæ‚¨çš„å­ä»»åŠ¡ä¹‹ä¸€å¼•å‘æœªæ•è·çš„é”™è¯¯ï¼Œåˆ™æ‰€æœ‰å‰©ä½™ä»»åŠ¡å°†è¢«éšå¼å–æ¶ˆã€‚</li>
</ol>
<p>é¦–å…ˆï¼Œè°ƒç”¨ <code>cancelAll()</code> å°†å–æ¶ˆæ‰€æœ‰å‰©ä½™çš„ä»»åŠ¡ã€‚ä¸ç‹¬ç«‹ä»»åŠ¡ä¸€æ ·ï¼Œå–æ¶ˆä»»åŠ¡ç»„æ˜¯åˆä½œæ€§çš„ï¼šä½ çš„å­ä»»åŠ¡å¯ä»¥ä½¿ç”¨ <code>Task.isCancelled</code> æˆ– <code>Task.checkCancellation()</code> æ¥æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆï¼Œä½†å¦‚æœå®ƒä»¬æ„¿æ„ï¼Œä¹Ÿå¯ä»¥å®Œå…¨å¿½ç•¥å–æ¶ˆæ“ä½œã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">printMessage</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">await</span> withThrowingTaskGroup(of: <span class="type">String</span>.<span class="keyword">self</span>) &#123; group -&gt; <span class="type">String</span> <span class="keyword">in</span></span><br><span class="line">    group.addTask &#123;</span><br><span class="line">      <span class="string">&quot;Testing&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    group.addTask &#123;</span><br><span class="line">      <span class="string">&quot;Group&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    group.addTask &#123;</span><br><span class="line">      <span class="string">&quot;Cancellation&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    group.cancelAll()</span><br><span class="line">    <span class="keyword">var</span> collected <span class="operator">=</span> [<span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="keyword">try</span> <span class="keyword">await</span> value <span class="keyword">in</span> group &#123;</span><br><span class="line">        collected.append(value)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="built_in">print</span>(error.localizedDescription)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> collected.joined(separator: <span class="string">&quot; &quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> printMessage()</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ï¼Œåœ¨åˆ›å»ºæ‰€æœ‰ä¸‰ä¸ªä»»åŠ¡åç«‹å³è°ƒç”¨ <code>cancelAll()</code>ï¼Œä½†æ˜¯å½“ä»£ç è¿è¡Œæ—¶ï¼Œæ‚¨ä»ç„¶ä¼šçœ‹åˆ°æ‰€æœ‰ä¸‰ä¸ªå­—ç¬¦ä¸²éƒ½æ‰“å°å‡ºæ¥ã€‚å› ä¸ºå–æ¶ˆä»»åŠ¡ç»„æ˜¯åˆä½œæ€§çš„ï¼Œæ‰€ä»¥é™¤éä½ æ·»åŠ çš„ä»»åŠ¡éšå¼æˆ–æ˜¾å¼åœ°æ£€æŸ¥å–æ¶ˆçŠ¶æ€ï¼Œå¦åˆ™å•ç‹¬è°ƒç”¨ <code>cancelAll()</code> å¹¶ä¸ä¼šæœ‰å¤ªå¤§ä½œç”¨ã€‚</p>
<p>å°è¯•å°†ç¬¬ä¸€ä¸ª <code>addTask()</code> è°ƒç”¨æ›¿æ¢ä¸ºï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">group.addTask &#123;</span><br><span class="line">  <span class="keyword">try</span> <span class="type">Task</span>.checkCancellation()</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Testing&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼šå‘ç°å…¶ç»“æœè¿˜æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™æ˜¯å› ä¸ºï¼šSwift å°†ç«‹å³å¯åŠ¨æ‰€æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼Œå®ƒä»¬å¯èƒ½å…¨éƒ¨å¹¶è¡Œè¿è¡Œï¼Œå°½ç®¡æˆ‘ä»¬ç«‹å³è°ƒç”¨ <code>cancelAll()</code>ï¼Œä½†æŸäº›ä»»åŠ¡å¯èƒ½å·²ç»å¼€å§‹è¿è¡Œã€‚</p>
<p>è¯·è®°ä½ï¼Œè°ƒç”¨ <code>cancelAll()</code> åªä¼šå–æ¶ˆå‰©ä½™çš„ä»»åŠ¡ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä¼šæ’¤é”€å·²ç»å®Œæˆçš„å·¥ä½œã€‚å³ä¾¿å¦‚æ­¤ï¼Œå–æ¶ˆä¹Ÿæ˜¯åˆä½œæ€§çš„ï¼Œå› æ­¤ä½ éœ€è¦ç¡®ä¿ä½ æ·»åŠ åˆ°ç»„ä¸­çš„ä»»åŠ¡ä¼šæ£€æŸ¥å–æ¶ˆçŠ¶æ€ã€‚</p>
<h3 id="å¦‚ä½•å¤„ç†ä»»åŠ¡ç»„ä¸­çš„ä¸åŒç»“æœç±»å‹"><a class="markdownIt-Anchor" href="#å¦‚ä½•å¤„ç†ä»»åŠ¡ç»„ä¸­çš„ä¸åŒç»“æœç±»å‹"></a> å¦‚ä½•å¤„ç†ä»»åŠ¡ç»„ä¸­çš„ä¸åŒç»“æœç±»å‹</h3>
<p>Swift ä»»åŠ¡ç»„ä¸­çš„æ¯ä¸ªä»»åŠ¡å¿…é¡»è¿”å›ä¸ç»„ä¸­æ‰€æœ‰å…¶ä»–ä»»åŠ¡ç›¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦ä¸€ä¸ªä»»åŠ¡ç»„æ¥å¤„ç†å¤šç§ä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œæ‚¨åº”è¯¥è€ƒè™‘ä½¿ç”¨ <code>async let</code> æ¥å®ç°å¹¶å‘ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰å…³è”å€¼çš„æšä¸¾ï¼Œè¯¥å€¼åŒ…è£…æ‚¨æƒ³è¦è¿”å›çš„åŸºç¡€æ•°æ®ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">FetchResult</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> username(<span class="type">String</span>)</span><br><span class="line">  <span class="keyword">case</span> favorites(<span class="type">Set</span>&lt;<span class="type">Int</span>&gt;)</span><br><span class="line">  <span class="keyword">case</span> messages([<span class="type">Message</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">loadUser</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> user <span class="operator">=</span> <span class="keyword">await</span> withThrowingTaskGroup(of: <span class="type">FetchResult</span>.<span class="keyword">self</span>) &#123; <span class="keyword">_</span> -&gt; <span class="type">User</span> <span class="keyword">in</span></span><br><span class="line">    <span class="comment">// more code here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> loadUser()</span><br></pre></td></tr></table></figure>
<h2 id="swiftui-ä¸­çš„-task-ä¿®é¥°ç¬¦"><a class="markdownIt-Anchor" href="#swiftui-ä¸­çš„-task-ä¿®é¥°ç¬¦"></a> SwiftUI ä¸­çš„ task() ä¿®é¥°ç¬¦</h2>
<p>SwiftUI æä¾›äº†ä¸€ä¸ª <code>task()</code> ä¿®é¥°ç¬¦ï¼Œä¸€æ—¦è§†å›¾å‡ºç°ï¼Œå®ƒå°±ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„åˆ†ç¦»ä»»åŠ¡ï¼Œå¹¶åœ¨è§†å›¾æ¶ˆå¤±æ—¶è‡ªåŠ¨å–æ¶ˆè¯¥ä»»åŠ¡ã€‚</p>
<ol>
<li>æœ€ç®€å•çš„ä¹Ÿæ˜¯å¸¸ç”¨çš„ï¼Œåœ¨ <code>task()</code> ä¸­åŠ è½½è§†å›¾åˆå§‹æ•°æ®ã€‚</li>
<li>æ›´é«˜çº§çš„ <code>task()</code> ç”¨æ³•æ˜¯é™„åŠ æŸç§ <code>Equatable</code> çš„æ ‡è¯†å€¼ <code>.task(id:)</code> â€”â€”å½“è¯¥å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒSwiftUI ä¼šè‡ªåŠ¨å–æ¶ˆä¹‹å‰çš„ä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨æ–°å€¼åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡ã€‚</li>
<li><code>task()</code> çš„ä¸€ä¸ªç‰¹åˆ«æœ‰è¶£çš„ç”¨ä¾‹æ˜¯ä¸è¿ç»­ç”Ÿæˆå€¼çš„ <code>AsyncSequence</code> é›†åˆä¸€èµ·ä½¿ç”¨ã€‚</li>
</ol>
<h2 id="actors"><a class="markdownIt-Anchor" href="#actors"></a> Actors</h2>
<p>Swift çš„ actors åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äºç±»ï¼Œä½†åœ¨å¹¶å‘ç¯å¢ƒä¸­ä½¿ç”¨æ˜¯å®‰å…¨çš„ã€‚è¿™ç§å®‰å…¨æ€§æ˜¯å› ä¸º Swift è‡ªåŠ¨ç¡®ä¿æ²¡æœ‰ä¸¤æ®µä»£ç è¯•å›¾åŒæ—¶è®¿é—® actor çš„æ•°æ®â€”â€”è¿™æ˜¯ç”±ç¼–è¯‘å™¨å¼ºåˆ¶å®ç°çš„ï¼Œè€Œä¸æ˜¯è¦æ±‚å¼€å‘äººå‘˜ç¼–å†™ä½¿ç”¨é”ç­‰ç³»ç»Ÿçš„æ ·æ¿ä»£ç ã€‚</p>
<ul>
<li>Actors æ˜¯ä½¿ç”¨ <code>actor</code> å…³é”®å­—åˆ›å»ºçš„ã€‚</li>
<li>Actors æ˜¯å¼•ç”¨ç±»å‹ã€‚</li>
<li>Actors å…·æœ‰è®¸å¤šä¸ç±»ç›¸åŒçš„ç‰¹æ€§ï¼šä½ å¯ä»¥ä¸ºå®ƒä»¬å®šä¹‰å±æ€§ã€æ–¹æ³•ï¼ˆå¼‚æ­¥æˆ–å…¶ä»–æ–¹æ³•ï¼‰ã€åˆå§‹åŒ–å™¨å’Œä¸‹æ ‡ï¼Œå®ƒä»¬å¯ä»¥éµå¾ªåè®®ï¼Œå¹¶ä¸”å¯ä»¥æ˜¯æ³›å‹ã€‚</li>
<li>Actors ä¸æ”¯æŒç»§æ‰¿ï¼Œå› æ­¤å®ƒä»¬ä¸èƒ½æœ‰ä¾¿åˆ©åˆå§‹åŒ–å™¨ï¼Œä¹Ÿä¸æ”¯æŒ <code>final</code> æˆ– <code>override</code>ã€‚</li>
<li>æ‰€æœ‰ actors ä¼šè‡ªåŠ¨éµå¾ª <code>Actor</code> åè®®ï¼Œè€Œå…¶ä»–ç±»å‹ä¸èƒ½ä½¿ç”¨è¯¥åè®®ã€‚è¿™ä½¿ä½ å¯ä»¥ç¼–å†™ä»…é™äºä¸ actor ä¸€èµ·å·¥ä½œçš„ä»£ç ã€‚</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œactor è¿˜æœ‰ä¸€ä¸ªæ ¸å¿ƒè¡Œä¸ºï¼šå¦‚æœä½ å°è¯•è¯»å– actor çš„å˜é‡å±æ€§æˆ–è°ƒç”¨å…¶æ–¹æ³•ï¼Œå¹¶ä¸”æ˜¯åœ¨ actor å¤–éƒ¨è¿›è¡Œçš„ï¼Œé‚£ä¹ˆä½ å¿…é¡»ä½¿ç”¨ <code>await</code> ä»¥å¼‚æ­¥æ–¹å¼è¿›è¡Œã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">actor</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> score <span class="operator">=</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">printScore</span>() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;My score is <span class="subst">\(score)</span>&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">copyScore</span>(<span class="params">from</span> <span class="params">other</span>: <span class="type">User</span>) <span class="keyword">async</span> &#123;</span><br><span class="line">    score <span class="operator">=</span> <span class="keyword">await</span> other.score</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> actor1 <span class="operator">=</span> <span class="type">User</span>()</span><br><span class="line"><span class="keyword">let</span> actor2 <span class="operator">=</span> <span class="type">User</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="built_in">print</span>(actor1.score)</span><br><span class="line"><span class="keyword">await</span> actor1.copyScore(from: actor2)</span><br></pre></td></tr></table></figure>
<p>ä» actor å¤–éƒ¨å†™å…¥å±æ€§æ˜¯ä¸å…è®¸çš„ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ <code>await</code>ã€‚</p>
<h3 id="å‡½æ•°å‚æ•°éš”ç¦»"><a class="markdownIt-Anchor" href="#å‡½æ•°å‚æ•°éš”ç¦»"></a> å‡½æ•°å‚æ•°éš”ç¦»</h3>
<p>å±äº actor çš„ä»»ä½•å±æ€§å’Œæ–¹æ³•éƒ½æ˜¯éš”ç¦»åˆ°è¯¥ actor çš„ï¼Œä½†å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥è®©å¤–éƒ¨å‡½æ•°ä¹Ÿéš”ç¦»åˆ°æŸä¸ª actorã€‚è¿™æ ·ï¼Œè¯¥å‡½æ•°å°±å¯ä»¥åƒåœ¨è¯¥ actor å†…éƒ¨ä¸€æ ·è®¿é—® actor éš”ç¦»çš„çŠ¶æ€ï¼Œè€Œæ— éœ€ä½¿ç”¨ <code>await</code>ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">actor</span> <span class="title class_">DataStore</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> username <span class="operator">=</span> <span class="string">&quot;Anonymous&quot;</span></span><br><span class="line">  <span class="keyword">var</span> friends <span class="operator">=</span> [<span class="type">String</span>]()</span><br><span class="line">  <span class="keyword">var</span> highScores <span class="operator">=</span> [<span class="type">Int</span>]()</span><br><span class="line">  <span class="keyword">var</span> favorites <span class="operator">=</span> <span class="type">Set</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">init</span>() &#123;</span><br><span class="line">    <span class="comment">// load data here</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>() &#123;</span><br><span class="line">    <span class="comment">// save data here</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">debugLog</span>(<span class="params">dataStore</span>: <span class="keyword">isolated</span> <span class="type">DataStore</span>) &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Username: <span class="subst">\(dataStore.username)</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Friends: <span class="subst">\(dataStore.friends)</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;High scores: <span class="subst">\(dataStore.highScores)</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;Favorites: <span class="subst">\(dataStore.favorites)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data <span class="operator">=</span> <span class="type">DataStore</span>()</span><br><span class="line"><span class="keyword">await</span> debugLog(dataStore: data)</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°ç­¾åä¸­æ·»åŠ çš„ <code>isolated</code> å…³é”®å­—ï¼Œå®ƒå…è®¸ç›´æ¥è®¿é—® <code>DataStore</code> çš„å±æ€§è€Œä¸éœ€è¦ä½¿ç”¨ <code>await</code>ï¼Œæ•´ä¸ªå‡½æ•°å¿…é¡»åœ¨è¯¥ actor ä¸Šè¿è¡Œï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ <code>await</code> è°ƒç”¨ <code>debugLog(dataStore:)</code>ã€‚</p>
<h3 id="éƒ¨åˆ†éš”ç¦»"><a class="markdownIt-Anchor" href="#éƒ¨åˆ†éš”ç¦»"></a> éƒ¨åˆ†éš”ç¦»</h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒActor å†…éƒ¨çš„æ‰€æœ‰æ–¹æ³•å’Œå¯å˜å±æ€§éƒ½ä¸è¯¥ Actor éš”ç¦»ï¼Œå¯ä»¥ä½¿ç”¨ <code>nonisolated</code> å…³é”®å­—å°†æŸäº›æ–¹æ³•æ’é™¤åœ¨å¤–ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CryptoKit</span><br><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">actor</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> username: <span class="type">String</span></span><br><span class="line">  <span class="keyword">let</span> password: <span class="type">String</span></span><br><span class="line">  <span class="keyword">var</span> isOnline <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">init</span>(<span class="params">username</span>: <span class="type">String</span>, <span class="params">password</span>: <span class="type">String</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.username <span class="operator">=</span> username</span><br><span class="line">    <span class="keyword">self</span>.password <span class="operator">=</span> password</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">nonisolated</span> <span class="keyword">func</span> <span class="title function_">passwordHash</span>() -&gt; <span class="type">String</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> passwordData <span class="operator">=</span> <span class="type">Data</span>(password.utf8)</span><br><span class="line">    <span class="keyword">let</span> hash <span class="operator">=</span> <span class="type">SHA256</span>.hash(data: passwordData)</span><br><span class="line">    <span class="keyword">return</span> hash.compactMap &#123; <span class="type">String</span>(format: <span class="string">&quot;%02x&quot;</span>, <span class="variable">$0</span>) &#125;.joined()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> user <span class="operator">=</span> <span class="type">User</span>(username: <span class="string">&quot;twostraws&quot;</span>, password: <span class="string">&quot;s3kr1t&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(user.passwordHash())</span><br></pre></td></tr></table></figure>
<ul>
<li>å°† <code>passwordHash()</code> æ ‡è®°ä¸º <code>nonisolated</code> æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨å¤–éƒ¨è°ƒç”¨å®ƒï¼Œè€Œæ— éœ€ä½¿ç”¨ <code>await</code>ã€‚</li>
<li>è¿˜å¯ä»¥å°† <code>nonisolated</code> ä¸è®¡ç®—å±æ€§ä¸€èµ·ä½¿ç”¨ã€‚</li>
<li>ééš”ç¦»å±æ€§å’Œæ–¹æ³•åªèƒ½è®¿é—®å…¶ä»–ééš”ç¦»å±æ€§å’Œæ–¹æ³•ã€‚</li>
</ul>
<h3 id="ä½¿ç”¨-mainactor-åœ¨ä¸»é˜Ÿåˆ—ä¸Šè¿è¡Œä»£ç "><a class="markdownIt-Anchor" href="#ä½¿ç”¨-mainactor-åœ¨ä¸»é˜Ÿåˆ—ä¸Šè¿è¡Œä»£ç "></a> ä½¿ç”¨ @MainActor åœ¨ä¸»é˜Ÿåˆ—ä¸Šè¿è¡Œä»£ç </h3>
<p><code>@MainActor</code> æ˜¯ä¸€ä¸ªå…¨å±€ actorï¼Œå®ƒä½¿ç”¨ä¸»é˜Ÿåˆ—æ¥æ‰§è¡Œå…¶å·¥ä½œã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¸¤ä¸ª <code>@Published</code> å±æ€§çš„å¯è§‚å¯Ÿå¯¹è±¡ï¼Œå¹¶ä¸”å› ä¸ºå®ƒä»¬éƒ½ä¼šæ›´æ–° UIï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ç”¨ <code>@MainActor</code> æ ‡è®°æ•´ä¸ªç±»ï¼Œä»¥ç¡®ä¿è¿™äº› UI æ›´æ–°å§‹ç»ˆå‘ç”Ÿåœ¨ main actorï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainActor</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AccountViewModel</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">  <span class="meta">@Published</span> <span class="keyword">var</span> username <span class="operator">=</span> <span class="string">&quot;Anonymous&quot;</span></span><br><span class="line">  <span class="meta">@Published</span> <span class="keyword">var</span> isAuthenticated <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šï¼Œä¸éœ€è¦æ˜¾å¼åœ°å°† <code>@MainActor</code> æ·»åŠ åˆ°å¯è§‚å¯Ÿå¯¹è±¡ï¼Œå› ä¸º SwiftUI è§†å›¾çš„ <code>body</code> å±æ€§å§‹ç»ˆåœ¨ä¸» actor ä¸Šè¿è¡Œã€‚å¦‚æœæ‚¨éœ€è¦æŸäº›æ–¹æ³•æˆ–è®¡ç®—å±æ€§æ¥é€‰æ‹©ä¸åœ¨ä¸» actor ä¸Šè¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ <code>nonisolated</code>ã€‚</p>
<p>æ›´å¹¿æ³›åœ°è¯´ï¼Œä»»ä½•åŒ…å« <code>@MainActor</code> å¯¹è±¡ä½œä¸ºå±æ€§çš„ç±»å‹ä¹Ÿä¼šéšå¼åœ°è¢«è®¤ä¸ºæ˜¯ <code>@MainActor</code>ï¼Œè¿™æ˜¯é€šè¿‡å…¨å±€ actor æ¨æ–­å®ç°çš„ã€‚</p>
<p><code>@MainActor</code> ä¼šè‡ªåŠ¨å¼ºåˆ¶æ–¹æ³•æˆ–æ•´ä¸ªç±»å‹åœ¨ä¸» actor ä¸Šè¿è¡Œï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€æˆ‘ä»¬åšä»»ä½•é¢å¤–çš„å·¥ä½œã€‚ä»¥å‰æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè®°å¾—åœ¨æ¯ä¸ªéœ€è¦çš„åœ°æ–¹ä½¿ç”¨è¯¸å¦‚ <code>DispatchQueue.main.async()</code> ä¹‹ç±»çš„ä»£ç ï¼Œä½†ç°åœ¨ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬å¤„ç†è¿™ä¸€åˆ‡ã€‚</p>
<p><code>MainActor.run()</code> æ–¹æ³•æ˜¯ Swift ä¸­ç”¨äºåœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œä»£ç çš„ä¸€ç§ä¾¿æ·æ–¹å¼ã€‚ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½ å¯ä»¥ç¡®ä¿æŒ‡å®šçš„ä»£ç å—åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œä»è€Œé¿å…æ‰‹åŠ¨åˆ‡æ¢çº¿ç¨‹çš„éº»çƒ¦ã€‚</p>
<ol>
<li>ç®€åŒ–çº¿ç¨‹åˆ‡æ¢ï¼š<code>MainActor.run()</code> ç®€åŒ–äº†å°†ä»£ç è°ƒåº¦åˆ°ä¸»çº¿ç¨‹çš„è¿‡ç¨‹ï¼Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>DispatchQueue.main.async()</code>ã€‚</li>
<li>æ”¯æŒå¼‚æ­¥ä»£ç ï¼š<code>MainActor.run()</code> æ”¯æŒå¼‚æ­¥ä»£ç ï¼Œä½ å¯ä»¥åœ¨å…¶å†…éƒ¨ä½¿ç”¨ <code>await</code>ã€‚</li>
<li>ä¿è¯ä¸»çº¿ç¨‹æ‰§è¡Œï¼šä½¿ç”¨ <code>MainActor.run()</code> å¯ä»¥ç¡®ä¿ä»£ç åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œé€‚ç”¨äºéœ€è¦åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œçš„ UI æ›´æ–°ç­‰ä»»åŠ¡ã€‚</li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">couldBeAnywhere</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> result <span class="operator">=</span> <span class="keyword">await</span> <span class="type">MainActor</span>.run &#123; () -&gt; <span class="type">Int</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is on the main actor.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span>(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> couldBeAnywhere()</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥å°†ä»»åŠ¡çš„ç»“æŸæ ‡è®°ä¸º <code>@MainActor</code>ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">couldBeAnywhere</span>() &#123;</span><br><span class="line">  <span class="type">Task</span> &#123; <span class="meta">@MainActor</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;This is on the main actor.&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">couldBeAnywhere()</span><br></pre></td></tr></table></figure>
<p><code>MainActor.run()</code> ä»£ç å°†ç«‹å³æ‰§è¡Œ - å®ƒä¸ä¼šåƒ <code>DispatchQueue.main.async()</code> é‚£æ ·ç­‰åˆ°ä¸‹ä¸€ä¸ªè¿è¡Œå¾ªç¯ã€‚</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainActor</span> <span class="keyword">class</span> <span class="title class_">ViewModel</span>: <span class="title class_">ObservableObject</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">runTest</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="type">MainActor</span>.run &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="type">Task</span> &#123; <span class="meta">@MainActor</span> <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>MainActor.run()</code> çš„è°ƒç”¨å°†åœ¨è°ƒç”¨ <code>runTest()</code> æ—¶ç«‹å³è¿è¡Œã€‚ä½†æ˜¯ï¼Œå†…éƒ¨çš„ <code>Task</code> ä¸ä¼šç«‹å³è¿è¡Œï¼Œå› æ­¤ä»£ç å°†æ‰“å° 1, 2, 4, 5, 3ã€‚</p>
<h3 id="å…¨å±€-actor-æ¨æ–­çš„å·¥ä½œåŸç†"><a class="markdownIt-Anchor" href="#å…¨å±€-actor-æ¨æ–­çš„å·¥ä½œåŸç†"></a> å…¨å±€ actor æ¨æ–­çš„å·¥ä½œåŸç†</h3>
<ol>
<li>
<p>å¦‚æœä¸€ä¸ªç±»è¢«æ ‡è®°ä¸º <code>@MainActor</code> ï¼Œé‚£ä¹ˆå®ƒçš„æ‰€æœ‰å­ç±»ä¹Ÿè‡ªåŠ¨è¢«æ ‡è®°ä¸º <code>@MainActor</code>ã€‚</p>
</li>
<li>
<p>å¦‚æœç±»ä¸­çš„æ–¹æ³•è¢«æ ‡è®°ä¸º <code>@MainActor</code> ï¼Œåˆ™è¯¥æ–¹æ³•çš„ä»»ä½•é‡å†™ä¹Ÿä¼šè‡ªåŠ¨æ ‡è®°ä¸º <code>@MainActor</code>ã€‚</p>
</li>
<li>
<p>ä»»ä½•ä½¿ç”¨ <code>@MainActor</code> ä½œä¸ºå…¶åŒ…è£…å€¼çš„å±æ€§åŒ…è£…å™¨çš„ç»“æ„æˆ–ç±»å°†è‡ªåŠ¨ä¸º <code>@MainActor</code>ã€‚</p>
</li>
<li>
<p>å¦‚æœä¸€ä¸ªåè®®å£°æ˜äº†ä¸€ä¸ªæ–¹æ³•æ˜¯ <code>@MainActor</code>ï¼Œé‚£ä¹ˆä»»ä½•éµå¾ªè¯¥åè®®çš„ç±»å‹éƒ½ä¼šè‡ªåŠ¨å°†è¯¥æ–¹æ³•è§†ä¸º <code>@MainActor</code>ï¼Œé™¤éä½ å°†åè®®çš„éµå¾ªä¸æ–¹æ³•çš„å®ç°åˆ†å¼€ã€‚</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A protocol with a single `@MainActor` method.</span></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">DataStoring</span> &#123;</span><br><span class="line">  <span class="meta">@MainActor</span> <span class="keyword">func</span> <span class="title function_">save</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A struct that does not conform to the protocol.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataStore1</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When we make it conform and add save() at the same time, our method is implicitly @MainActor.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">DataStore1</span>: <span class="title class_">DataStoring</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>() &#123; &#125; <span class="comment">// This is automatically @MainActor.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A struct that conforms to the protocol.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataStore2</span>: <span class="title class_">DataStoring</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we later add the save() method, it will *not* be implicitly @MainActor so we need to mark it as such ourselves.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">DataStore2</span> &#123;</span><br><span class="line">  <span class="meta">@MainActor</span> <span class="keyword">func</span> <span class="title function_">save</span>() &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å¦‚æœæ•´ä¸ªåè®®æ ‡è®°ä¸º <code>@MainActor</code>ï¼Œé‚£ä¹ˆä»»ä½•éµå¾ªè¯¥åè®®çš„ç±»å‹åœ¨ä¸æ˜¾å¼åˆ†ç¦»åè®®éµå¾ªä¸ä¸»ç±»å‹å£°æ˜çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šè‡ªåŠ¨æˆä¸º <code>@MainActor</code>ï¼›è€Œå¦‚æœä½ å°†åè®®çš„éµå¾ªä¸ä¸»ç±»å‹å£°æ˜åˆ†ç¦»å¼€æ¥ï¼Œé‚£ä¹ˆåªæœ‰æ–¹æ³•ä¼šè¢«æ ‡è®°ä¸º <code>@MainActor</code>ã€‚</p>
 <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A protocol marked as @MainActor.</span></span><br><span class="line"><span class="meta">@MainActor</span> <span class="keyword">protocol</span> <span class="title class_">DataStoring</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A struct that conforms to DataStoring as part of its primary type definition.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataStore1</span>: <span class="title class_">DataStoring</span> &#123; <span class="comment">// This struct is automatically @MainActor.</span></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>() &#123; &#125; <span class="comment">// This method is automatically @MainActor.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Another struct that conforms to DataStoring as part of its primary type definition.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataStore2</span>: <span class="title class_">DataStoring</span> &#123; &#125; <span class="comment">// This struct is automatically @MainActor.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The method is provided in an extension, but it&#x27;s the same as if it were in the primary type definition.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">DataStore2</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>() &#123; &#125; <span class="comment">// This method is automatically @MainActor.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A third struct that does *not* conform to DataStoring in its primary type definition.</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DataStore3</span> &#123; &#125; <span class="comment">// This struct is not @MainActor.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The conformance is added as an extension</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">DataStore3</span>: <span class="title class_">DataStoring</span> &#123;</span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">save</span>() &#123; &#125; <span class="comment">// This method is automatically @MainActor.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="actor-è·³è·ƒ"><a class="markdownIt-Anchor" href="#actor-è·³è·ƒ"></a> actor è·³è·ƒ</h3>
<p>å½“ä¸€ä¸ªçº¿ç¨‹æš‚åœä¸€ä¸ª actor ä¸Šçš„å·¥ä½œï¼Œè½¬è€Œå¼€å§‹åœ¨å¦ä¸€ä¸ª actor ä¸Šå·¥ä½œæ—¶ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º actor è·³è·ƒï¼ˆactor hoppingï¼‰ã€‚è¿™ç§æƒ…å†µä¼šåœ¨ä¸€ä¸ª actor è°ƒç”¨å¦ä¸€ä¸ª actor æ—¶å‘ç”Ÿã€‚Actor hopping çš„å‘ç”Ÿå¯ä»¥ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç®¡ç†ï¼Œç¡®ä¿å¹¶å‘æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§å’Œé¡ºåºæ‰§è¡Œï¼Œè€Œæ— éœ€å¼€å‘äººå‘˜æ˜¾å¼ç®¡ç†çº¿ç¨‹åˆ‡æ¢ã€‚</p>
<p>ä½†è¿˜æ˜¯æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li>æ€§èƒ½å½±å“ï¼šActor è·³è·ƒå¯èƒ½ä¼šå¼•å…¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œå› ä¸ºçº¿ç¨‹éœ€è¦åœ¨ä¸åŒçš„ actor ä¹‹é—´åˆ‡æ¢ã€‚å°½ç®¡ Swift çš„å¹¶å‘æ¨¡å‹å°½å¯èƒ½åœ°ä¼˜åŒ–äº†è¿™äº›åˆ‡æ¢è¿‡ç¨‹ï¼Œä½†é¢‘ç¹çš„ actor è·³è·ƒä»å¯èƒ½å½±å“åˆ°åº”ç”¨ç¨‹åºçš„å“åº”æ€§èƒ½ã€‚</li>
<li>çº¿ç¨‹å®‰å…¨ï¼šç”±äº Swift çš„ Actor æ¨¡å‹ç¡®ä¿äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª actor çš„ä»£ç å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤ actor è·³è·ƒå¯ä»¥ä¿è¯å¹¶å‘è®¿é—®çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚ç„¶è€Œï¼Œå¼€å‘äººå‘˜ä»éœ€æ³¨æ„é¿å…å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶æˆ–æ•°æ®ä¸ä¸€è‡´çš„æ“ä½œã€‚</li>
<li>å¼‚æ­¥æ“ä½œï¼šåœ¨æ‰§è¡Œ actor è·³è·ƒæ—¶ï¼Œå¯èƒ½æ¶‰åŠå¼‚æ­¥æ“ä½œå’Œç­‰å¾…ã€‚ç‰¹åˆ«æ˜¯å½“ä¸€ä¸ª actor è°ƒç”¨å¦ä¸€ä¸ª actor çš„å¼‚æ­¥æ–¹æ³•æ—¶ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ await æ¥ç­‰å¾…ç»“æœçš„è¿”å›ï¼Œä»¥ç¡®ä¿å¼‚æ­¥æ“ä½œçš„æ­£ç¡®é¡ºåºã€‚</li>
<li>ä»£ç è®¾è®¡ï¼šåˆç†çš„ä»£ç è®¾è®¡å¯ä»¥å‡å°‘ actor è·³è·ƒçš„é¢‘ç‡ã€‚å°½é‡å°†ç›¸å…³çš„æ“ä½œå’Œæ•°æ®å°è£…åœ¨åŒä¸€ä¸ª actor å†…éƒ¨ï¼Œå‡å°‘ä¸åŒ actor ä¹‹é—´çš„äº¤äº’ï¼Œå¯ä»¥é™ä½ actor è·³è·ƒçš„å‘ç”Ÿé¢‘ç‡ï¼Œæå‡æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ol>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">actor</span> <span class="title class_">NumberGenerator</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> lastNumber <span class="operator">=</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">func</span> <span class="title function_">getNext</span>() -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> &#123; lastNumber <span class="operator">+=</span> <span class="number">1</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> lastNumber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@MainActor</span> <span class="keyword">func</span> <span class="title function_">run</span>() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">_</span> <span class="keyword">in</span> <span class="number">1</span> <span class="operator">...</span> <span class="number">100</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> nextNumber <span class="operator">=</span> <span class="keyword">await</span> getNext()</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Loading <span class="subst">\(nextNumber)</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> generator <span class="operator">=</span> <span class="type">NumberGenerator</span>()</span><br><span class="line"><span class="keyword">await</span> generator.run()</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>run()</code> æ–¹æ³•å¿…é¡»åœ¨ä¸» actor ä¸Šæ‰§è¡Œï¼Œå› ä¸ºå®ƒå¸¦æœ‰ <code>@MainActor</code> å±æ€§ï¼Œç„¶è€Œ <code>getNext()</code> æ–¹æ³•å°†åœ¨åä½œæ± ï¼ˆcooperative poolï¼‰çš„æŸä¸ªåœ°æ–¹è¿è¡Œï¼Œè¿™æ„å‘³ç€ Swift éœ€è¦åœ¨å¾ªç¯å†…é¢‘ç¹åœ°åœ¨ä¸» actor å’Œåä½œæ± ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<h3 id="actors-classes-and-structs-ä¹‹é—´çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#actors-classes-and-structs-ä¹‹é—´çš„åŒºåˆ«"></a> actors, classes, and structs ä¹‹é—´çš„åŒºåˆ«</h3>
<p>Actors:</p>
<ul>
<li>æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€‚åˆç”¨äºå…±äº«å¯å˜çŠ¶æ€ã€‚</li>
<li>å¯ä»¥æ‹¥æœ‰å±æ€§ã€æ–¹æ³•ã€åˆå§‹åŒ–å™¨å’Œä¸‹æ ‡ã€‚</li>
<li>ä¸æ”¯æŒç»§æ‰¿ã€‚</li>
<li>è‡ªåŠ¨éµå¾ª Actor åè®®ã€‚</li>
<li>è‡ªåŠ¨éµå¾ª AnyObject åè®®ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸æ·»åŠ æ˜¾å¼ id å±æ€§çš„æƒ…å†µä¸‹éµå¾ª Identifiable åè®®ã€‚</li>
<li>å¯ä»¥æœ‰ææ„å™¨ã€‚</li>
<li>ä¸èƒ½ç›´æ¥ä»å¤–éƒ¨è®¿é—®å…¶å…¬å…±å±æ€§å’Œæ–¹æ³•ï¼›å¿…é¡»ä½¿ç”¨ awaitã€‚</li>
<li>åªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œæ— è®ºå®ƒä»¬å¦‚ä½•è¢«è®¿é—®ã€‚</li>
</ul>
<p>Classesï¼š</p>
<ul>
<li>æ˜¯å¼•ç”¨ç±»å‹ï¼Œé€‚åˆç”¨äºå…±äº«å¯å˜çŠ¶æ€ã€‚</li>
<li>å¯ä»¥æ‹¥æœ‰å±æ€§ã€æ–¹æ³•ã€åˆå§‹åŒ–å™¨å’Œä¸‹æ ‡ã€‚</li>
<li>æ”¯æŒç»§æ‰¿ã€‚</li>
<li>ä¸èƒ½éµå¾ª Actor åè®®ã€‚</li>
<li>è‡ªåŠ¨éµå¾ª AnyObject åè®®ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸æ·»åŠ æ˜¾å¼ id å±æ€§çš„æƒ…å†µä¸‹éµå¾ª Identifiable åè®®ã€‚</li>
<li>å¯ä»¥æœ‰ææ„å™¨ã€‚</li>
<li>å¯ä»¥ç›´æ¥ä»å¤–éƒ¨è®¿é—®å…¶å…¬å…±å±æ€§å’Œæ–¹æ³•ã€‚</li>
<li>å¯èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªæ–¹æ³•ã€‚</li>
</ul>
<p>Structsï¼š</p>
<ul>
<li>æ˜¯å€¼ç±»å‹ï¼Œä¼šè¢«å¤åˆ¶è€Œä¸æ˜¯å…±äº«ã€‚</li>
<li>å¯ä»¥æ‹¥æœ‰å±æ€§ã€æ–¹æ³•ã€åˆå§‹åŒ–å™¨å’Œä¸‹æ ‡ã€‚</li>
<li>ä¸æ”¯æŒç»§æ‰¿ã€‚</li>
<li>ä¸èƒ½éµå¾ª Actor åè®®ã€‚</li>
<li>ä¸èƒ½éµå¾ª AnyObject åè®®ï¼›å¦‚æœè¦æ·»åŠ  Identifiable åè®®çš„éµå¾ªï¼Œå¿…é¡»è‡ªå·±æ·»åŠ  id å±æ€§ã€‚</li>
<li>ä¸èƒ½æœ‰ææ„å™¨ã€‚</li>
<li>å¯ä»¥ç›´æ¥ä»å¤–éƒ¨è®¿é—®å…¶å…¬å…±å±æ€§å’Œæ–¹æ³•ã€‚</li>
<li>å¯èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªæ–¹æ³•ã€‚</li>
</ul>
<h2 id="å¦è§"><a class="markdownIt-Anchor" href="#å¦è§"></a> å¦è§</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/swift/concurrency">Concurrency Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingwithswift.com/quick-start/concurrency">Swift Concurrency by Example</a></li>
</ul>
</div><div class="tags"><a href="/tags/Concurrency"><i class="fa fa-tag">Concurrency</i></a></div><div class="post-nav"><a class="pre" href="/newsletter/118/">Kilig çš„ç¢å‘¨æŠ¥ - #118ï¼ˆ2024.07.29ï¼‰</a><a class="next" href="/docker/">Docker å¤‡å¿˜æ¸…å•</a></div><link rel="stylesheet" type="text/css" href="https://unpkg.com/disqusjs@1.3/dist/disqusjs.css"><script type="text/javascript" src="https://unpkg.com/disqusjs@1.3/dist/disqus.js"></script><script type="text/javascript" id="disqus-count-script">$(function() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '//disqus.com/next/config.json', true);
  xhr.timeout = 2500;
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
      $('.post-meta .post-comments-count').show();
      var s = document.createElement('script');
      s.id = 'dsq-count-scr';
      s.src = 'https://kiligwyu.disqus.com/count.js';
      s.async = true;
      (document.head || document.body).appendChild(s);
    }
  };
  xhr.ontimeout = function () { xhr.abort(); };
  xhr.send(null);
});</script><div class="comments" id="disqus_thread"><script type="text/javascript">// Load comments with DisqusJS
function loadComments() {
  window.dsqjs = new DisqusJS({
    shortname: 'kiligwyu',
    siteName: 'ğ•¶ğ–ğ–‘ğ–ğ–Œ\'ğ–˜ ğ•­ğ–‘ğ–”ğ–Œ',
    identifier: 'concurrency/',
    url: 'http://kiligwyu.com/concurrency/',
    title: 'Concurrency å¤‡å¿˜æ¸…å•',
    api: '',
    apikey: '',
    admin: 'kiligwyu',
    adminLabel: ''
  });
}
// Lazy load {# Credit: https://github.com/theme-next/hexo-theme-next/blob/master/layout/_third-party/comments/disqus.swig #}
(function () {
  var offsetTop = document.getElementById('disqus_thread').offsetTop - window.innerHeight;
  if (offsetTop <= 0) {
    // Load directly when there's no scrollbar
    window.addEventListener('load', loadComments, false);
  } else {
    var disqusScroll = function () {
      // offsetTop may changes because of manually resizing browser window or lazy loading images
      var offsetTop = document.getElementById('disqus_thread').offsetTop - window.innerHeight;
      var scrollTop = window.scrollY;

      // Pre-load comments a bit? (margin or anything else)
      if (offsetTop - scrollTop < 60) {
        window.removeEventListener('scroll', disqusScroll);
        loadComments();
      }
    };
    window.addEventListener('scroll', disqusScroll);
  }
})();
// Scroll to comments automatically if #comment-xxx anchor specified
window.addEventListener('load', function () {
  // I don't know why, it just works.
  window.setTimeout(function () {
    if (location.hash.indexOf('#comment-') !== -1) {
      document.getElementById('disqus_thread').scrollIntoView(true);
    }
  }, 100);
}, false);
</script></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright Â© 2025 <a href="/." rel="nofollow">ğ•¶ğ–ğ–‘ğ–ğ–Œ'ğ–˜ ğ•­ğ–‘ğ–”ğ–Œ.</a><br> è±« ICP å¤‡ 404 å· - 1
<br> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>